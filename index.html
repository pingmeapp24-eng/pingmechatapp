<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PingMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* কাস্টম স্ক্রলবার স্টাইল */
        #messages-container::-webkit-scrollbar,
        #chat-list-container::-webkit-scrollbar,
        #friends-page-container::-webkit-scrollbar,
        #ai-messages-container::-webkit-scrollbar,
        #groups-page-container::-webkit-scrollbar {
            width: 6px;
        }
        #messages-container::-webkit-scrollbar-thumb,
        #chat-list-container::-webkit-scrollbar-thumb,
        #friends-page-container::-webkit-scrollbar-thumb,
        #ai-messages-container::-webkit-scrollbar-thumb,
        #groups-page-container::-webkit-scrollbar-thumb {
            background-color: #5B5BD6;
            border-radius: 10px;
        }
        
        /* চ্যাট বাবল স্টাইল */
        .bubble-me {
            border-top-left-radius: 1.125rem;
            border-top-right-radius: 1.125rem;
            border-bottom-left-radius: 1.125rem;
            border-bottom-right-radius: 0.25rem;
            max-width: 80%;
        }
        .bubble-other {
            border-top-left-radius: 1.125rem;
            border-top-right-radius: 1.125rem;
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 1.125rem;
            max-width: 80%;
        }
        /* ফন্ট */
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen antialiased">

    <div id="main-container" class="flex flex-col md:flex-row h-screen">

        <div id="sidebar" class="w-full md:w-80 bg-gray-800 flex flex-col border-r border-gray-700">
            <div class="p-4 border-b border-gray-700 flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-indigo-400">PingMe</h1>
                    <button id="user-info-btn" class="text-gray-400 hover:text-indigo-400 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.98 5.98 0 0010 16a5.979 5.979 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="user-info-display" class="bg-gray-700 p-2 rounded-lg text-sm hidden">
                    <p class="font-semibold text-indigo-300">Your ID:</p>
                    <p id="current-user-id" class="break-all text-xs text-gray-300"></p>
                    <p class="mt-1 text-xs text-yellow-400">Share this ID to add friends.</p>
                </div>
            </div>
            
            <nav class="flex text-sm font-medium border-b border-gray-700">
                <button id="chat-tab" class="flex-1 p-3 text-center border-b-2 border-indigo-500 text-indigo-400 transition-colors">Chats</button>
                <button id="friends-tab" class="flex-1 p-3 text-center border-b-2 border-transparent text-gray-400 hover:text-indigo-400 transition-colors">Friends</button>
                <button id="groups-tab" class="flex-1 p-3 text-center border-b-2 border-transparent text-gray-400 hover:text-indigo-400 transition-colors">Groups</button>
                <button id="ai-tab" class="flex-1 p-3 text-center border-b-2 border-transparent text-gray-400 hover:text-indigo-400 transition-colors">AI</button>
            </nav>

            <div id="chat-list-container" class="flex-1 overflow-y-auto">
                <div id="chat-list-content">
                    <div id="global-chat-link" class="flex items-center p-3 cursor-pointer hover:bg-gray-700 transition duration-150 border-l-4 border-indigo-500">
                        <div class="relative">
                            <span class="inline-flex items-center justify-center h-12 w-12 rounded-full bg-indigo-600 text-lg font-semibold">G</span>
                        </div>
                        <div class="ml-3 flex-1 min-w-0">
                            <p class="text-sm font-semibold truncate text-white">Global Chat</p>
                            <p class="text-xs text-gray-400 truncate" id="last-global-message">Tap to start chatting...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="friends-page-container" class="flex-1 overflow-y-auto hidden">
                <div class="p-3 border-b border-gray-700">
                    <button id="add-friend-btn" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">Add Friend</button>
                    <div id="add-friend-form" class="mt-3 p-3 bg-gray-700 rounded-lg hidden">
                        <input type="text" id="friend-id-input" placeholder="Enter Friend's User ID" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        <button id="submit-friend-request" class="mt-2 w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">Search/Add</button>
                        <p id="friend-status-message" class="mt-2 text-center text-xs text-gray-300"></p>
                    </div>
                </div>
                <h2 class="text-lg font-semibold p-3 text-indigo-300 border-b border-gray-700">Your Friends</h2>
                <div id="friend-list-content">
                    </div>
            </div>

            <div id="groups-page-container" class="flex-1 overflow-y-auto hidden">
                <div class="p-3 border-b border-gray-700">
                    <button id="create-group-btn" class="w-full bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition font-semibold text-sm">Create New Group</button>
                    <div id="create-group-form" class="mt-3 p-3 bg-gray-700 rounded-lg hidden">
                        <input type="text" id="group-name-input" placeholder="Group Name" class="w-full p-2 rounded-lg bg-gray-800 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm mb-2">
                        <button id="submit-group-creation" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition font-semibold text-sm">Create Group</button>
                    </div>
                </div>
                <h2 class="text-lg font-semibold p-3 text-indigo-300 border-b border-gray-700">Your Groups</h2>
                <div id="group-list-content">
                    </div>
            </div>

            <div id="ai-page-container" class="flex-1 overflow-y-auto hidden">
                <div id="ai-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <div class="flex justify-start">
                        <div class="bubble-other bg-gray-700 text-white p-3 rounded-lg shadow-md">
                            <p class="font-semibold text-indigo-300">Gemini AI</p>
                            <p>Hi there! I'm your assistant. Ask me anything, and I'll try to find up-to-date information for you.</p>
                        </div>
                    </div>
                </div>
                <form id="ai-chat-form" class="p-3 border-t border-gray-700 flex items-center bg-gray-800">
                    <input type="text" id="ai-chat-input" placeholder="Ask Gemini..." required class="flex-1 p-3 rounded-l-lg bg-gray-700 border-none focus:outline-none text-white placeholder-gray-400">
                    <button type="submit" class="bg-indigo-600 text-white p-3 rounded-r-lg hover:bg-indigo-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </button>
                </form>
            </div>

        </div>

        <div id="chat-area" class="flex-1 flex flex-col hidden md:flex">
            <div id="chat-header" class="bg-gray-800 p-4 border-b border-gray-700 flex items-center justify-between">
                <h2 id="chat-name" class="text-xl font-semibold">Global Chat</h2>
                <div class="flex items-center space-x-4">
                    <p id="typing-status" class="text-sm text-green-400 hidden">Typing...</p>
                    <button class="text-gray-400 hover:text-indigo-400 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                </div>

            <form id="chat-form" class="p-4 border-t border-gray-700 flex items-center bg-gray-800">
                <button type="button" id="emoji-toggle-btn" class="text-gray-400 hover:text-yellow-400 p-2 rounded-full transition"></button>
                <input type="text" id="chat-input" placeholder="Type a message..." required class="flex-1 p-3 mx-2 rounded-lg bg-gray-700 border-none focus:outline-none text-white placeholder-gray-400">
                <button type="button" id="attach-file-btn" class="text-gray-400 hover:text-indigo-400 p-2 rounded-full transition"></button>
                <button type="submit" class="bg-indigo-600 text-white p-3 ml-2 rounded-lg hover:bg-indigo-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </button>
            </form>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 space-y-2"></div>

    <script type="module">
        // Firebase Imports (v11.6.1)
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, orderBy, limit, addDoc, serverTimestamp, arrayUnion, arrayRemove, where, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Added analytics import

        // Global Variables
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyADEk13HgPmPjiy2VD6RDYU_Z2pPJFM9gQ",
          authDomain: "pingme-7fad3.firebaseapp.com",
          databaseURL: "https://pingme-7fad3-default-rtdb.firebaseio.com",
          projectId: "pingme-7fad3",
          storageBucket: "pingme-7fad3.firebasestorage.app",
          messagingSenderId: "8513825883",
          appId: "1:8513825883:web:b8676bbdb4818c3d4ae37e",
          measurementId: "G-TNN3PTP5YP"
        };

        const appId = firebaseConfig.appId; // Using appId from the config
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const CHAT_ROOM_ID = 'global_chat'; // সবার জন্য একক চ্যাট রুম

        // Firebase Service Instances
        let app, db, auth, analytics; // Added analytics
        let userId = null; // বর্তমান ইউজারের আইডি
        let userDisplayName = 'Unknown User'; // ইউজারের ডিসপ্লে নাম

        // DOM Elements
        const mainContainer = document.getElementById('main-container');
        const sidebar = document.getElementById('sidebar');
        const chatArea = document.getElementById('chat-area');
        const messagesContainer = document.getElementById('messages-container');
        const aiMessagesContainer = document.getElementById('ai-messages-container');
        const chatInput = document.getElementById('chat-input');
        const chatForm = document.getElementById('chat-form');
        const typingStatusDisplay = document.getElementById('typing-status');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        
        const chatListTab = document.getElementById('chat-tab');
        const friendsTab = document.getElementById('friends-tab');
        const groupsTab = document.getElementById('groups-tab');
        const aiTab = document.getElementById('ai-tab');

        const chatListContainer = document.getElementById('chat-list-container');
        const friendsPageContainer = document.getElementById('friends-page-container');
        const groupsPageContainer = document.getElementById('groups-page-container');
        const aiPageContainer = document.getElementById('ai-page-container');

        const addFriendBtn = document.getElementById('add-friend-btn');
        const addFriendForm = document.getElementById('add-friend-form');
        const friendIdInput = document.getElementById('friend-id-input');
        const submitFriendRequest = document.getElementById('submit-friend-request');
        const friendStatusMessage = document.getElementById('friend-status-message');

        const createGroupBtn = document.getElementById('create-group-btn');
        const createGroupForm = document.getElementById('create-group-form');
        const groupNameInput = document.getElementById('group-name-input');
        const submitGroupCreation = document.getElementById('submit-group-creation');

        const aiChatInput = document.getElementById('ai-chat-input');
        const aiChatForm = document.getElementById('ai-chat-form');
        
        // State
        let currentView = 'chat'; // 'chat', 'friends', 'groups', 'ai'
        let typingTimeout = null;
        let lastTypingUpdate = 0;
        let aiMessageIdCounter = 0; // AI মেসেজের জন্য আইডি কাউন্টার

        // Utility Functions
        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('bn-BD', { hour: '2-digit', minute: '2-digit' });
        }

        function sanitizeInput(text) {
            const tempDiv = document.createElement('div');
            tempDiv.textContent = text;
            return tempDiv.innerHTML;
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-3 rounded-lg shadow-xl text-white text-sm transition-opacity duration-300 ${
                type === 'error' ? 'bg-red-600' : 'bg-green-600'
            }`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Firestore Paths (Shared for public data, Private for user-specific data)
        const firestorePaths = {
            // পাবলিক চ্যাট মেসেজ
            MESSAGES_COLLECTION: () => `artifacts/${appId}/public/data/chats/${CHAT_ROOM_ID}/messages`,
            // পাবলিক ইউজার প্রোফাইল (খুঁজে পাওয়ার জন্য)
            USER_PROFILES_COLLECTION: () => `artifacts/${appId}/public/data/profiles`,
            // প্রাইভেট ফ্রেন্ড লিস্ট ডকুমেন্ট
            FRIENDS_LIST_DOC: (uid) => doc(db, `artifacts/${appId}/users/${uid}/metadata/data/friends`),
            // পাবলিক টাইপিং স্ট্যাটাস
            TYPING_STATUS_COLLECTION: () => `artifacts/${appId}/public/data/typing_status`,
            // পাবলিক গ্রুপস
            GROUPS_COLLECTION: () => `artifacts/${appId}/public/data/groups`,
        };

        // --- Firebase Initialization and Auth ---

        async function initFirebase() {
            try {
                // The check for projectId is removed as firebaseConfig is now hardcoded
                setLogLevel('debug'); // ফায়ারবেস লগিং চালু
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app); // Initialize analytics
                
                // Auth লিসেনার সেটআপ
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDisplayName = `User-${userId.substring(0, 4)}`; // সহজ ডিসপ্লে নাম
                        currentUserIdDisplay.textContent = userId;
                        console.log('User signed in:', userId);

                        // ১. ইউজার প্রোফাইল তৈরি বা আপডেট করা
                        await createOrUpdateUserProfile(userId);
                        
                        // ২. মূল লিসেনারগুলো চালু করা
                        setupMainListeners();

                        // ৩. UI দেখানো
                        showView(currentView);
                    } else {
                        // যদি ইউজার না থাকে, সাইন ইন করার চেষ্টা করা
                        await handleInitialSignIn();
                    }
                });

                // যদি onAuthStateChanged প্রথমে user না পায়, তবে এই ফাংশনটি চলবে
                if (!auth.currentUser) {
                    await handleInitialSignIn();
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showToast("Error initializing Firebase. Check console for details.", 'error');
            }
        }

        async function handleInitialSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log('Signed in with custom token.');
                } else {
                    await signInAnonymously(auth);
                    console.log('Signed in anonymously.');
                }
            } catch (error) {
                console.error('Initial sign-in failed:', error);
                showToast(`Authentication failed: ${error.message}`, 'error');
            }
        }

        async function createOrUpdateUserProfile(uid) {
            const profileDocRef = doc(db, firestorePaths.USER_PROFILES_COLLECTION(), uid);
            const friendListDocRef = firestorePaths.FRIENDS_LIST_DOC(uid);

            // পাবলিক প্রোফাইল (সকলের জন্য দৃশ্যমান)
            await setDoc(profileDocRef, {
                userId: uid,
                displayName: userDisplayName,
                lastActive: serverTimestamp()
            }, { merge: true });

            // প্রাইভেট ফ্রেন্ড লিস্ট ডকুমেন্ট (প্রথমবার তৈরির জন্য)
            await setDoc(friendListDocRef, {
                friends: [],
                pendingRequests: []
            }, { merge: true });
        }


        // --- Core Chat Functionality ---

        function appendMessage(msg) {
            const senderIsMe = msg.senderId === userId;
            const sanitizedText = sanitizeInput(msg.text);
            const bubbleClass = senderIsMe ? 'bubble-me bg-indigo-600 ml-auto' : 'bubble-other bg-gray-700';
            const alignmentClass = senderIsMe ? 'justify-end' : 'justify-start';

            const messageHtml = `
                <div class="flex ${alignmentClass}">
                    <div class="${bubbleClass} text-white p-3 rounded-lg shadow-md flex flex-col">
                        ${!senderIsMe ? `<p class="font-semibold text-indigo-300 text-xs mb-1 break-all">${msg.senderName || 'Anonymous'}</p>` : ''}
                        <p class="break-words whitespace-pre-wrap">${sanitizedText}</p>
                        <p class="text-xs text-right mt-1 ${senderIsMe ? 'text-indigo-200' : 'text-gray-400'}">${formatTime(msg.timestamp)}</p>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function sendMessage(text) {
            if (!userId) return;

            const messagesColRef = collection(db, firestorePaths.MESSAGES_COLLECTION());
            try {
                await addDoc(messagesColRef, {
                    senderId: userId,
                    senderName: userDisplayName,
                    text: text,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Error sending message:", error);
                showToast("Failed to send message.", 'error');
            }
        }

        function setupChatListener() {
            if (!db) return;
            const messagesColRef = collection(db, firestorePaths.MESSAGES_COLLECTION());
            const q = query(messagesColRef, orderBy('timestamp', 'asc'), limit(100));

            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const message = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === 'added') {
                        appendMessage(message);
                    }
                    // For simplicity, we only handle 'added' type for chat messages
                });
            }, (error) => {
                console.error("Error setting up chat listener:", error);
                showToast("Error loading chat messages.", 'error');
            });
        }
        
        // --- Typing Status Logic ---

        async function updateTypingStatus(isTyping) {
            if (!db || !userId) return;
            const now = Date.now();
            
            // স্প্যামিং এড়াতে প্রতি ১ সেকেন্ডে একবার আপডেট করা হবে
            if (isTyping && now - lastTypingUpdate < 1000) {
                return;
            }
            lastTypingUpdate = now;

            const typingDocRef = doc(db, firestorePaths.TYPING_STATUS_COLLECTION(), userId);
            try {
                await setDoc(typingDocRef, {
                    isTyping: isTyping,
                    lastUpdated: serverTimestamp(),
                    userId: userId,
                    displayName: userDisplayName
                }, { merge: true });
            } catch (error) {
                console.error("Error updating typing status:", error);
            }
        }

        function setupTypingListener() {
            if (!db) return;
            const typingColRef = collection(db, firestorePaths.TYPING_STATUS_COLLECTION());
            
            onSnapshot(typingColRef, (snapshot) => {
                let otherUsersTyping = false;
                snapshot.forEach((doc) => {
                    const status = doc.data();
                    // যদি অন্য কোনো ইউজার টাইপ করে এবং গত ৬ সেকেন্ডের মধ্যে আপডেট হয়
                    if (status.userId !== userId && status.isTyping && (Date.now() - status.lastUpdated.toDate().getTime() < 6000)) {
                        otherUsersTyping = true;
                    }
                });

                if (otherUsersTyping) {
                    typingStatusDisplay.classList.remove('hidden');
                } else {
                    typingStatusDisplay.classList.add('hidden');
                }

            }, (error) => {
                console.error("Error setting up typing listener:", error);
            });
        }


        // --- Friends Management ---

        function displayFriend(friendId) {
            const friendListContent = document.getElementById('friend-list-content');
            
            // একটি সহজ লিস্ট আইটেম তৈরি করা
            const friendItem = document.createElement('div');
            friendItem.className = 'flex items-center p-3 hover:bg-gray-700 transition duration-150 border-b border-gray-700';
            friendItem.innerHTML = `
                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-green-600 text-sm font-semibold">${friendId.substring(0, 1)}</span>
                <div class="ml-3 flex-1 min-w-0">
                    <p class="text-sm font-semibold truncate text-white">Friend: ${friendId.substring(0, 8)}...</p>
                    <p class="text-xs text-gray-400 truncate break-all">ID: ${friendId}</p>
                </div>
            `;
            friendListContent.appendChild(friendItem);
        }

        async function handleSearchAndAddFriend(e) {
            e.preventDefault();
            const targetId = friendIdInput.value.trim();
            friendStatusMessage.textContent = '';
            if (!targetId || targetId === userId) {
                friendStatusMessage.textContent = 'Invalid ID or this is your ID.';
                friendStatusMessage.className = 'mt-2 text-center text-xs text-red-400';
                return;
            }

            const profileColRef = collection(db, firestorePaths.USER_PROFILES_COLLECTION());
            const q = query(profileColRef, where('userId', '==', targetId));

            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    friendStatusMessage.textContent = 'User not found.';
                    friendStatusMessage.className = 'mt-2 text-center text-xs text-red-400';
                    return;
                }

                // ফ্রেন্ড লিস্ট আপডেটের জন্য নিজের ডকুমেন্ট রেফারেন্স
                const myFriendDocRef = firestorePaths.FRIENDS_LIST_DOC(userId);
                
                // এখানে সরলতার জন্য, কোনো "রিকোয়েস্ট" না পাঠিয়ে সরাসরি ফ্রেন্ড লিস্টে যোগ করা হবে (পাবলিক আইডি)
                // রিয়েল অ্যাপ্লিকেশনে এখানে ফ্রেন্ড রিকোয়েস্টের লজিক থাকবে।
                
                await updateDoc(myFriendDocRef, {
                    friends: arrayUnion(targetId)
                });
                
                showToast(`User ${targetId.substring(0, 8)}... added as friend!`);
                friendIdInput.value = '';

            } catch (error) {
                console.error("Error adding friend:", error);
                friendStatusMessage.textContent = 'An error occurred while adding friend.';
                friendStatusMessage.className = 'mt-2 text-center text-xs text-red-400';
            }
        }

        function setupFriendsListener() {
            if (!db || !userId) return;
            const friendDocRef = firestorePaths.FRIENDS_LIST_DOC(userId);
            const friendListContent = document.getElementById('friend-list-content');

            onSnapshot(friendDocRef, (docSnap) => {
                friendListContent.innerHTML = '';
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.friends && data.friends.length > 0) {
                        data.friends.forEach(displayFriend);
                    } else {
                        friendListContent.innerHTML = '<p class="p-3 text-center text-gray-400">No friends yet. Add using an ID!</p>';
                    }
                }
            }, (error) => {
                console.error("Error setting up friends listener:", error);
                showToast("Error loading friends list.", 'error');
            });
        }


        // --- Groups Management (Placeholder for simplicity) ---

        async function handleGroupCreation(e) {
            e.preventDefault();
            const groupName = groupNameInput.value.trim();
            if (!groupName) return;

            const groupsColRef = collection(db, firestorePaths.GROUPS_COLLECTION());
            try {
                await addDoc(groupsColRef, {
                    name: groupName,
                    members: [userId],
                    creatorId: userId,
                    createdAt: serverTimestamp()
                });
                groupNameInput.value = '';
                createGroupForm.classList.add('hidden');
                showToast(`Group "${groupName}" created successfully!`);
            } catch (error) {
                console.error("Error creating group:", error);
                showToast("Failed to create group.", 'error');
            }
        }

        function displayGroup(group) {
            const groupListContent = document.getElementById('group-list-content');
            
            const groupItem = document.createElement('div');
            groupItem.className = 'flex items-center p-3 cursor-pointer hover:bg-gray-700 transition duration-150 border-b border-gray-700';
            groupItem.innerHTML = `
                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-yellow-600 text-sm font-semibold">G</span>
                <div class="ml-3 flex-1 min-w-0">
                    <p class="text-sm font-semibold truncate text-white">${group.name}</p>
                    <p class="text-xs text-gray-400 truncate">Members: ${group.members.length}</p>
                </div>
            `;
            groupListContent.appendChild(groupItem);
        }

        function setupGroupsListener() {
            if (!db || !userId) return;
            const groupsColRef = collection(db, firestorePaths.GROUPS_COLLECTION());
            
            // শুধু মাত্র যে গ্রুপগুলোর মেম্বার বর্তমান ইউজার, সেগুলোর জন্য লিসেনার
            const q = query(groupsColRef, where('members', 'array-contains', userId));
            const groupListContent = document.getElementById('group-list-content');

            onSnapshot(q, (snapshot) => {
                groupListContent.innerHTML = '';
                if (snapshot.empty) {
                    groupListContent.innerHTML = '<p class="p-3 text-center text-gray-400">No groups yet. Create one!</p>';
                } else {
                    snapshot.forEach((doc) => {
                        displayGroup({ id: doc.id, ...doc.data() });
                    });
                }
            }, (error) => {
                console.error("Error setting up groups listener:", error);
                showToast("Error loading groups list.", 'error');
            });
        }


        // --- AI Chat Functionality (Gemini API) ---

        function appendAiMessage(role, text) {
            const messageId = `ai-msg-${aiMessageIdCounter++}`;
            const isUser = role === 'user';
            const bubbleClass = isUser ? 'bubble-me bg-indigo-600 ml-auto' : 'bubble-other bg-gray-700';
            const alignmentClass = isUser ? 'justify-end' : 'justify-start';
            const name = isUser ? userDisplayName : 'Gemini AI';

            const messageHtml = `
                <div class="flex ${alignmentClass}" id="${messageId}">
                    <div class="${bubbleClass} text-white p-3 rounded-lg shadow-md flex flex-col">
                        <p class="font-semibold ${isUser ? 'text-indigo-200' : 'text-indigo-300'} text-xs mb-1 break-all">${name}</p>
                        <p class="message-content break-words whitespace-pre-wrap">${text}</p>
                    </div>
                </div>
            `;
            aiMessagesContainer.insertAdjacentHTML('beforeend', messageHtml);
            aiMessagesContainer.scrollTop = aiMessagesContainer.scrollHeight;
            return messageId;
        }

        function updateAiMessage(id, newText) {
            const messageElement = document.getElementById(id);
            if (messageElement) {
                const contentElement = messageElement.querySelector('.message-content');
                if (contentElement) {
                    // Markdown থেকে HTML কনভার্ট করার জন্য সহজ ব্যবস্থা
                    let htmlContent = newText.replace(/\*\*\*(.*?)\*\*\*/gs, '<br><hr class="my-2 border-gray-600"><p class="text-xs font-semibold">Sources:</p>');
                    htmlContent = htmlContent.replace(/\[Source (\d+): (.*?)\]\((.*?)\)/g, (match, num, title, uri) => 
                        `<a href="${uri}" target="_blank" class="text-indigo-300 hover:underline text-xs block">${num}. ${title}</a>`
                    );
                    htmlContent = htmlContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                    htmlContent = htmlContent.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic
                    htmlContent = htmlContent.replace(/^- (.*)/gm, '<li>$1</li>').replace(/(\n<li>.*<\/li>)+/gs, '<ul>$1</ul>'); // Lists
                    htmlContent = htmlContent.replace(/\n/g, '<br>'); // Newlines

                    contentElement.innerHTML = htmlContent;
                    aiMessagesContainer.scrollTop = aiMessagesContainer.scrollHeight;
                }
            }
        }

        async function handleAiChatSubmit(e) {
            e.preventDefault();
            const prompt = aiChatInput.value.trim();
            if (!prompt) return;

            // ইনপুট ক্লিয়ার
            aiChatInput.value = '';

            // ১. ইউজার মেসেজ ডিসপ্লে
            appendAiMessage('user', prompt);
            const loadingMessageId = appendAiMessage('assistant', 'Loading...');

            // ২. API কল সেটআপ
            //apiKey গ্লোবাল ভ্যারিয়েবল হিসেবে না থাকায় এখানে খালি স্ট্রিং রাখা হয়েছে। Canvas এটি রুটিন অনুযায়ী যুক্ত করবে।
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a helpful and friendly assistant named Gemini. Provide concise, clear, and easy-to-understand answers. Use markdown formatting for readability and ensure the response is grounded in provided search results if available.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }], // Google Search Grounding চালু
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                // Exponential Backoff (সহজ করে)
                let response;
                let attempts = 0;
                const maxAttempts = 3;
                while (attempts < maxAttempts) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status !== 429) { // 429 Rate Limit হলে আবার চেষ্টা করবে
                            break;
                        }

                        // Wait before retrying
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        attempts++;

                    } catch (error) {
                        // Network error, treat as non-retryable for simplicity
                        throw error;
                    }
                }

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let aiText = candidate.content.parts[0].text;
                    let sources = [];
                    
                    // সোর্স এক্সট্র্যাক্ট করা
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // মেসেজ টেক্সটের সাথে সোর্স যোগ করা
                    if (sources.length > 0) {
                        aiText += "\n\n***\n";
                        sources.forEach((source, index) => {
                            aiText += `[Source ${index + 1}: ${source.title}](${source.uri})\n`;
                        });
                    }

                    // লোডিং মেসেজ আপডেট
                    updateAiMessage(loadingMessageId, aiText);

                } else {
                    updateAiMessage(loadingMessageId, 'Sorry, I could not generate a response. The candidate structure was unexpected.');
                }

            } catch (error) {
                console.error('Gemini API Error:', error);
                updateAiMessage(loadingMessageId, `An error occurred: ${error.message}. Please check console.`);
            }
        }


        // --- UI and Event Handlers ---

        function showView(viewName) {
            // সকল কন্টেইনার এবং ট্যাব নিষ্ক্রিয় করা
            [chatListContainer, friendsPageContainer, groupsPageContainer, aiPageContainer].forEach(el => el.classList.add('hidden'));
            [chatListTab, friendsTab, groupsTab, aiTab].forEach(el => {
                el.classList.remove('border-indigo-500', 'text-indigo-400');
                el.classList.add('border-transparent', 'text-gray-400');
            });
            chatArea.classList.add('hidden'); // চ্যাট এরিয়া ডিফল্টভাবে লুকানো

            let activeContainer, activeTab;
            
            // সক্রিয় কন্টেইনার ও ট্যাব সেট করা
            switch (viewName) {
                case 'chat':
                    activeContainer = chatListContainer;
                    activeTab = chatListTab;
                    chatArea.classList.remove('hidden');
                    break;
                case 'friends':
                    activeContainer = friendsPageContainer;
                    activeTab = friendsTab;
                    break;
                case 'groups':
                    activeContainer = groupsPageContainer;
                    activeTab = groupsTab;
                    break;
                case 'ai':
                    activeContainer = aiPageContainer;
                    activeTab = aiTab;
                    break;
            }

            if (activeContainer) activeContainer.classList.remove('hidden');
            if (activeTab) {
                activeTab.classList.add('border-indigo-500', 'text-indigo-400');
                activeTab.classList.remove('border-transparent', 'text-gray-400');
            }
            
            currentView = viewName;
        }

        // --- Event Listeners and Initial Setup ---

        function initApp() {
            // Firebase ও Auth চালু করা
            initFirebase();

            // চ্যাট ফর্ম সাবমিট হ্যান্ডলার
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (text) {
                    sendMessage(text);
                    chatInput.value = '';
                    updateTypingStatus(false); // মেসেজ পাঠানোর পর টাইপিং বন্ধ
                }
            });

            // চ্যাট ইনপুটে টাইপিং স্ট্যাটাস আপডেট
            chatInput.addEventListener('input', () => {
                // টাইপিং স্ট্যাটাস ফায়ারস্টোরে আপডেট করা
                updateTypingStatus(true);
                
                // ২ সেকেন্ড পরে টাইপিং বন্ধের জন্য সেট করা
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => updateTypingStatus(false), 2000); 
            });

            // ফ্রেন্ডস ফর্ম সাবমিট হ্যান্ডলার
            submitFriendRequest.addEventListener('click', handleSearchAndAddFriend);

            // ফ্রেন্ডস পেজে ফর্ম টগল
            addFriendBtn.addEventListener('click', () => {
                addFriendForm.classList.toggle('hidden');
            });

            // গ্রুপ ফর্ম সাবমিট হ্যান্ডলার
            submitGroupCreation.addEventListener('click', handleGroupCreation);

            // গ্রুপ পেজে ফর্ম টগল
            createGroupBtn.addEventListener('click', () => {
                createGroupForm.classList.toggle('hidden');
            });
            
            // AI চ্যাট ফর্ম সাবমিট হ্যান্ডলার
            aiChatForm.addEventListener('submit', handleAiChatSubmit);


            // ট্যাব পরিবর্তন হ্যান্ডলার
            chatListTab.addEventListener('click', () => showView('chat'));
            friendsTab.addEventListener('click', () => showView('friends'));
            groupsTab.addEventListener('click', () => showView('groups'));
aiTab.addEventListener('click', () => showView('ai'));
            document.getElementById('global-chat-link').addEventListener('click', () => showView('chat'));

            // ইউজার আইডি ডিসপ্লে টগল
            document.getElementById('user-info-btn').addEventListener('click', () => {
                document.getElementById('user-info-display').classList.toggle('hidden');
            });

            // আইকনগুলোর SVG কোড যোগ করা
            document.getElementById('emoji-toggle-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            document.getElementById('attach-file-btn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>`;
        }
        
        // সকল Firestore লিসেনার চালু করার জন্য ফাংশন
        function setupMainListeners() {
            if (userId) {
                // চ্যাট পেজের জন্য লিসেনার
                setupChatListener();
                setupTypingListener();
                
                // ফ্রেন্ডস পেজের জন্য লিসেনার
                setupFriendsListener();
                
                // গ্রুপস পেজের জন্য লিসেনার
                setupGroupsListener();
            }
        }
        
        // DOM লোড হলে অ্যাপ চালু করা
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
