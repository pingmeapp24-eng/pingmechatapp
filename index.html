<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PingMe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* === থিম কালার === */
        :root {
            --theme-color-1: #fbc02d; /* হলুদ */
            --theme-color-2: #3b82f6; /* নীল */
            --theme-color-3: #22d3ee; /* সায়ান */
        }
        #messages-container::-webkit-scrollbar,
        #chat-list-container::-webkit-scrollbar,
        #friends-page-container::-webkit-scrollbar,
        #groups-page-container::-webkit-scrollbar,
        #profile-page-main::-webkit-scrollbar,
        #friend-profile-page-main::-webkit-scrollbar {
            width: 6px;
        }
        #messages-container::-webkit-scrollbar-thumb,
        #chat-list-container::-webkit-scrollbar-thumb,
        #friends-page-container::-webkit-scrollbar-thumb,
        #groups-page-container::-webkit-scrollbar-thumb,
        #profile-page-main::-webkit-scrollbar-thumb,
        #friend-profile-page-main::-webkit-scrollbar-thumb {
            background-color: var(--theme-color-1);
            border-radius: 10px;
        }
        .bubble-me {
            border-top-left-radius: 1.125rem;
            border-top-right-radius: 1.125rem;
            border-bottom-left-radius: 1.125rem;
            border-bottom-right-radius: 0.25rem;
        }
        .bubble-other {
            border-top-left-radius: 1.125rem;
            border-top-right-radius: 1.125rem;
            border-bottom-left-radius: 0.25rem;
            border-bottom-right-radius: 1.125rem;
        }
        .hidden { display: none; }
        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 420px; 
            margin: 0 auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        .header-gradient {
            background-image: linear-gradient(to right, var(--theme-color-3), var(--theme-color-2));
        }
        .toast-show {
            display: block !important;
            opacity: 1 !important;
            transform: translate(-50%, 0) !important;
        }
        .nav-btn i { transition: all 0.2s ease-in-out; }

        /* === নতুন সংযোজন: মেসেজ মেনু স্টাইল === */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 40;
        }
        .modal-content {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background-color: white;
            z-index: 50;
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -10px 20px rgba(0,0,0,0.1);
        }
        .dark .modal-content { background-color: #1f2937; } /* gray-800 */
        
        /* === নতুন সংযোজন: রিপ্লে প্রিভিউ === */
        #reply-preview-bar {
            background-color: #f3f4f6; /* gray-100 */
            border-top: 1px solid #e5e7eb; /* gray-200 */
        }
        .dark #reply-preview-bar {
            background-color: #374151; /* gray-700 */
            border-top-color: #4b5563; /* gray-600 */
        }
        
        /* === নতুন সংযোজন: কোটেড রিপ্লে === */
        .quoted-reply {
            background-color: rgba(0, 0, 0, 0.05);
            border-left: 3px solid var(--theme-color-1);
            padding: 4px 8px;
            border-radius: 6px;
            margin-bottom: 6px;
        }
        .dark .quoted-reply {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* === নতুন সংযোজন: রিয়্যাকশন === */
        .reaction-list {
            position: absolute;
            bottom: -12px;
            left: 12px;
            display: flex;
            gap: 2px;
        }
        .bubble-me .reaction-list {
            left: auto;
            right: 12px;
        }
        .reaction-item {
            font-size: 0.75rem;
            padding: 2px 4px;
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .dark .reaction-item {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563; /* gray-600 */
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 font-sans overflow-hidden">

    <div class="page-container">

        <!-- === পেজ: লগইন === -->
        <div id="login-page" class="flex flex-col h-full">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0 text-center">
                <h1 class="text-2xl font-bold">Welcome to PingMe</h1>
            </header>
            <main class="flex-1 flex flex-col justify-center items-center p-6 bg-gray-100 dark:bg-gray-900 overflow-y-auto">
                
                <div id="login-form-container" class="w-full max-w-sm">
                    <div class="p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                        <h2 class="text-xl font-semibold text-center mb-6">Sign In</h2>
                        <div id="login-message" class="mb-4"></div>
                        <div class="space-y-4">
                            <div>
                                <label for="login-email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email</label>
                                <input type="email" id="login-email" class="w-full mt-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="your@email.com" />
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Password</label>
                                <input type="password" id="login-password" class="w-full mt-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="••••••••" />
                            </div>
                            <button id="login-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 shadow-md">
                                Sign In
                            </button>
                        </div>
                        <div class="mt-4 text-sm text-center">
                            <button id="forgot-password-btn" class="text-blue-600 dark:text-blue-400 hover:underline">Forgot Password?</button>
                        </div>
                        <div class="my-6 flex items-center justify-center">
                            <span class="border-t border-gray-300 dark:border-gray-600 flex-grow"></span>
                            <span class="px-3 text-sm text-gray-500 dark:text-gray-400">or</span>
                            <span class="border-t border-gray-300 dark:border-gray-600 flex-grow"></span>
                        </div>
                        <button id="show-register-btn" class="w-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-medium py-3 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                            Create New Account
                        </button>
                    </div>
                </div>
    
                <div id="register-form-container" class="w-full max-w-sm hidden">
                    <div class="p-8 bg-white dark:bg-gray-800 rounded-2xl shadow-xl">
                        <h2 class="text-xl font-semibold text-center mb-6">Create Account</h2>
                        <div id="register-message" class="mb-4"></div>
                        <div class="space-y-4">
                            <div>
                                <label for="register-email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email</label>
                                <input type="email" id="register-email" class="w-full mt-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="your@email.com" />
                            </div>
                            <div>
                                <label for="register-password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Password</label>
                                <input type="password" id="register-password" class="w-full mt-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="Min. 6 characters" />
                            </div>
                            <div>
                                <label for="register-confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Confirm Password</label>
                                <input type="password" id="register-confirm-password" class="w-full mt-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="Repeat password" />
                            </div>
                            <button id="register-btn" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 shadow-md">
                                Register
                            </button>
                        </div>
                        <div class="mt-6 text-sm text-center">
                            <button id="show-login-btn" class="text-blue-600 dark:text-blue-400 hover:underline">
                                Already have an account? Sign In
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- === পেজ: চ্যাট লিস্ট === -->
        <div id="chat-list-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold">PingMe</h1>
                    <div class="flex items-center space-x-2">
                        <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/20">
                            <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                            <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </button>
                        </div>
                </div>
            </header>
            <main id="chat-list-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 dark:bg-gray-900">
                <div class="text-center pt-10"><span class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-sm rounded-full">Loading chats...</span></div>
            </main>
        </div>

        <!-- === পেজ: বন্ধু তালিকা === -->
        <div id="friends-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center space-x-3">
                    <button class="nav-back-btn p-1" data-target="chat-list-page">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold">Friends</h1>
                </div>
            </header>
            <main id="friends-page-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 dark:bg-gray-900">
                
                <div class="p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-gray-100">Find Friends</h3>
                    <div class="flex space-x-2">
                        <input type="text" id="friend-search-input" class="flex-1 w-full p-2 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700" placeholder="Enter friend's Ping ID" />
                        <button id="friend-search-btn" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>

                <div id="friend-search-results" class="space-y-3 mt-4">
                    </div>

            </main>
        </div>

        <!-- === পেজ: গ্রুপস === -->
        <div id="groups-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center space-x-3">
                    <button class="nav-back-btn p-1" data-target="chat-list-page">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                    </button>
                    <h1 class="text-2xl font-bold">Groups</h1>
                </div>
            </header>
            <main id="groups-page-container" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-100 dark:bg-gray-900">
                <div class="text-center pt-10"><span class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-sm rounded-full">Group functionality coming soon.</span></div>
            </main>
        </div>


        <!-- === পেজ: প্রোফাইল === -->
        <div id="profile-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button class="nav-back-btn p-1" data-target="chat-list-page">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <h1 class="text-2xl font-bold">Profile</h1>
                    </div>
                    <button id="toggle-profile-edit-btn" class="p-2 rounded-full hover:bg-white/20">
                        <i id="profile-edit-icon" class="fas fa-pencil-alt h-5 w-5"></i>
                        <i id="profile-save-icon" class="fas fa-save h-5 w-5 hidden"></i>
                    </button>
                </div>
            </header>
            <main id="profile-page-main" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-100 dark:bg-gray-900">
                <div class="flex flex-col items-center space-y-2">
                    <img id="profile-pic-preview" src="https://placehold.co/128x128/fbc02d/ffffff?text=User" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover shadow-lg" />
                    <input type="file" id="profile-pic-input" class="hidden" accept="image/*" />
                    <div class="flex space-x-3">
                        <button id="change-pic-btn" class="text-sm text-blue-500 dark:text-blue-400 hover:underline">Change Photo</button>
                        <button id="profile-pic-link-btn" class="text-sm text-yellow-500 dark:text-yellow-400 hover:underline">Use Link</button>
                    </div>
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Your PingMe ID</label>
                    <p id="profile-user-id" class="text-sm text-gray-900 dark:text-gray-100 truncate">Connecting...</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="profile-display-name" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Display Name</label>
                        <input type="text" id="profile-display-name" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" disabled />
                    </div>
                    <div>
                        <label for="profile-bio" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Bio</label>
                        <textarea id="profile-bio" rows="3" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" placeholder="Tell everyone about yourself..." disabled></textarea>
                    </div>
                    <div>
                        <label for="profile-email" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email</label>
                        <input type="email" id="profile-email" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" placeholder="your@email.com" disabled />
                    </div>
                    <div>
                        <label for="profile-phone" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Phone</label>
                        <input type="tel" id="profile-phone" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" placeholder="+880..." disabled />
                    </div>
                    <div>
                        <label for="profile-birthdate" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Birthdate</label>
                        <input type="date" id="profile-birthdate" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" disabled />
                    </div>
                    <div>
                        <label for="profile-gender" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Gender</label>
                        <select id="profile-gender" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" disabled>
                            <option value="not_specified">Prefer not to say</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="profile-marital-status" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Marital Status</label>
                        <select id="profile-marital-status" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 disabled:bg-gray-200 dark:disabled:bg-gray-800/50 disabled:opacity-70" disabled>
                            <option value="not_specified">Prefer not to say</option>
                            <option value="single">Single</option>
                            <option value="married">Married</option>
                            <option value="divorced">Divorced</option>
                            <option value="widowed">Widowed</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                    <button id="sign-out-btn" class="w-full bg-white dark:bg-gray-800 text-red-600 dark:text-red-400 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 shadow-md flex items-center justify-center space-x-2 font-medium">
                        <span>Sign Out</span>
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </main>
            </div>

        <!-- === পেজ: বন্ধুর প্রোফাইল === -->
        <div id="friend-profile-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button id="friend-profile-back-btn" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <h1 id="friend-profile-header-name" class="text-2xl font-bold">Friend's Profile</h1>
                    </div>
                </div>
            </header>
            <main id="friend-profile-page-main" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-100 dark:bg-gray-900">
                <div class="flex flex-col items-center space-y-2">
                    <img id="friend-profile-pic-preview" src="https://placehold.co/128x128/fbc02d/ffffff?text=?" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover shadow-lg" />
                </div>
                <div class="p-3 bg-white dark:bg-gray-800 rounded-lg shadow">
                    <label class="block text-xs font-medium text-gray-500 dark:text-gray-400">Ping ID</label>
                    <p id="friend-profile-user-id" class="text-sm text-gray-900 dark:text-gray-100 truncate">...</p>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Display Name</label>
                        <p id="friend-profile-display-name" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Bio</label>
                        <p id="friend-profile-bio" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md min-h-[40px]">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Email</label>
                        <p id="friend-profile-email" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Phone</label>
                        <p id="friend-profile-phone" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Birthdate</label>
                        <p id="friend-profile-birthdate" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Gender</label>
                        <p id="friend-profile-gender" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Marital Status</label>
                        <p id="friend-profile-marital-status" class="w-full mt-1 p-2 text-gray-900 dark:text-gray-100 bg-gray-200 dark:bg-gray-800/50 rounded-md">...</p>
                    </div>
                </div>

                <div class="pt-4">
                    <button id="friend-profile-start-chat-btn" class="w-full bg-blue-500 text-white py-2.5 rounded-lg hover:bg-blue-600 shadow-md flex items-center justify-center space-x-2 font-medium">
                        <span>Start Chat</span>
                        <i class="fas fa-comments"></i>
                    </button>
                </div>
            </main>
        </div>

        <!-- === পেজ: চ্যাট === -->
        <div id="chat-page" class="flex flex-col h-full hidden">
            <header class="header-gradient text-white p-4 shadow-lg rounded-b-3xl z-10 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button id="back-to-chat-list" class="p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <button id="chat-header-profile-btn" class="flex items-center space-x-3 rounded-lg p-1 -ml-1 hover:bg-white/10">
                            <img id="chat-header-avatar" src="https://placehold.co/40x40/fbc02d/ffffff?text=?" alt="Avatar" class="w-10 h-10 rounded-full object-cover" />
                            <div>
                                <h1 id="chat-header-name" class="text-lg font-semibold text-left">...</h1>
                                <p id="chat-header-status" class="text-xs text-blue-200 h-4 text-left">&nbsp;</p> 
                            </div>
                        </button>
                    </div>
                    <div class="w-10 h-10"></div>
                </div>
            </header>
            
            <main id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-100 dark:bg-gray-900"></main>
            
            <div id="emoji-panel" class="p-2 grid grid-cols-6 gap-2 bg-white dark:bg-gray-800 shadow-inner hidden shrink-0">
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">😀</button>
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">😂</button>
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">❤️</button>
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">👍</button>
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">😢</button>
                <button class="emoji-btn text-2xl hover:bg-gray-200 dark:hover:bg-gray-700 rounded">🎉</button>
            </div>
            
            <!-- === নতুন সংযোজন: রিপ্লে প্রিভিউ বার === -->
            <div id="reply-preview-bar" class="p-2 hidden shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2 min-w-0">
                        <i class="fas fa-reply text-gray-500 dark:text-gray-400"></i>
                        <div class="min-w-0">
                            <p id="reply-preview-name" class="text-sm font-semibold truncate text-gray-900 dark:text-gray-100">Replying to...</p>
                            <p id="reply-preview-content" class="text-sm truncate text-gray-600 dark:text-gray-300">...</p>
                        </div>
                    </div>
                    <button id="cancel-reply-btn" class="p-1 text-gray-500 dark:text-gray-400 hover:text-red-500 dark:hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <footer class="p-3 bg-transparent shrink-0">
                <form id="chat-form" class="flex items-center bg-white dark:bg-gray-800 rounded-full shadow-xl p-2">
                    <button type="button" id="emoji-toggle-btn" class="p-2 text-gray-500 dark:text-gray-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                    
                    <button type="button" id="send-link-btn" class="p-2 text-gray-500 dark:text-gray-400 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899l4-4a4 4 0 10-5.656-5.656l-1.102 1.101" />
                        </svg>
                    </button>
                    
                    <input type="text" id="message-input" class="flex-1 p-2 bg-transparent text-gray-900 dark:text-gray-100 focus:outline-none" placeholder="Type a message..." disabled />
                    <button type="submit" id="send-button" class="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 ml-2 disabled:bg-blue-400 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </form>
            </footer>
        </div>

        <!-- === মডাল: নতুন ইউজার প্রোফাইল === -->
        <div id="profile-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 hidden">
             <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full">
                <h2 class="text-xl font-semibold mb-4">Welcome to PingMe!</h2>
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">Please set a display name to continue.</p>
                <label for="display-name-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Display Name</label>
                <input type="text" id="display-name-input" class="w-full mt-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700" />
                <button id="modal-save-profile-btn" class="w-full mt-4 bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">Save</button>
            </div>
        </div>

        <!-- === মডাল: টেক্সট/ইউআরএল প্রম্পট (পরিবর্তিত) === -->
        <div id="text-prompt-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-sm shadow-2xl">
                <h3 id="text-prompt-title" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Enter URL</h3>
                
                <p id="text-prompt-helper" class="text-xs text-gray-500 dark:text-gray-400 mb-3 hidden">
                    Need to upload an image? Try: 
                    <a href="https://postimages.org/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">
                        postimages.org
                    </a>
                </p>

                <input type="text" id="text-prompt-input" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg dark:bg-gray-700 mb-4" placeholder="..." />
                <div class="flex justify-end space-x-3">
                    <button id="text-prompt-cancel" class="py-2 px-4 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button id="text-prompt-save" class="py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save</button>
                </div>
            </div>
        </div>

        <!-- === নতুন সংযোজন: মেসেজ কনটেক্সট মেনু মডাল === -->
        <div id="message-context-menu" class="hidden">
            <div id="message-context-backdrop" class="modal-backdrop"></div>
            <div class="modal-content p-4">
                <!-- রিয়্যাকশন বার -->
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <button class="menu-reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-emoji="👍">👍</button>
                    <button class="menu-reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-emoji="❤️">❤️</button>
                    <button class="menu-reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-emoji="😂">😂</button>
                    <button class="menu-reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-emoji="😢">😢</button>
                    <button class="menu-reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-emoji="😡">😡</button>
                </div>
                <hr class="border-gray-200 dark:border-gray-600 my-2"/>
                <!-- অপশন লিস্ট -->
                <div class="flex flex-col">
                    <button id="menu-reply-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-3">
                        <i class="fas fa-reply w-5 text-center"></i>
                        <span>Reply</span>
                    </button>
                    <button id="menu-edit-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-3">
                        <i class="fas fa-pencil-alt w-5 text-center"></i>
                        <span>Edit</span>
                    </button>
                    <button id="menu-delete-btn" class="w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-3 text-red-600 dark:text-red-400">
                        <i class="fas fa-trash w-5 text-center"></i>
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- === নতুন সংযোজন: কনফার্মেশন মডাল === -->
        <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 dark:bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-xs shadow-2xl">
                <h3 id="confirm-modal-title" class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Are you sure?</h3>
                <p id="confirm-modal-text" class="text-sm text-gray-600 dark:text-gray-300 mb-6">This action cannot be undone.</p>
                <div class="flex justify-end space-x-3">
                    <button id="confirm-modal-cancel" class="py-2 px-4 text-gray-600 dark:text-gray-400 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">Cancel</button>
                    <button id="confirm-modal-confirm" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button>
                </div>
            </div>
        </div>

        <!-- === নোটিফিকেশন: টোস্ট === -->
        <div id="toast-notification" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-y-10 opacity-0">
            Profile saved successfully!
        </div>

        <!-- === নেভিগেশন: বটম ন্যাভবার === -->
        <nav id="bottom-nav" class="w-full bg-white dark:bg-gray-800 border-t dark:border-gray-700 grid grid-cols-4 gap-2 p-3 shrink-0 shadow-inner hidden">
            <button data-page="chat-list-page" class="nav-btn flex flex-col items-center text-blue-500 dark:text-blue-400">
                <i class="fas fa-comments text-2xl"></i>
                <span class="text-xs font-medium mt-1">Chats</span>
            </button>
            <button data-page="friends-page" class="nav-btn flex flex-col items-center text-gray-500 dark:text-gray-400 opacity-70">
                <i class="fas fa-users text-lg"></i>
                <span class="text-xs font-medium mt-1">Friends</span>
            </button>
            <button data-page="groups-page" class="nav-btn flex flex-col items-center text-gray-500 dark:text-gray-400 opacity-70">
                <i class="fas fa-user-friends text-lg"></i> <span class="text-xs font-medium mt-1">Groups</span>
            </button>
            <button data-page="profile-page" class="nav-btn flex flex-col items-center text-gray-500 dark:text-gray-400 opacity-70">
                <i class="fas fa-user-circle text-lg"></i>
                <span class="text-xs font-medium mt-1">Profile</span>
            </button>
        </nav>
    </div>

    <!-- ========= স্ক্রিপ্ট সেকশন (পরিবর্তিত) ========= -->
    <script type="module">
        // Firebase মডিউল
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendEmailVerification, 
            sendPasswordResetEmail, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            updateDoc, 
            query, 
            collection, 
            where, 
            onSnapshot, 
            increment, 
            serverTimestamp, 
            setLogLevel,
            getDocs,
            writeBatch,
            // addDoc - আর ব্যবহৃত হচ্ছে না
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


        // --- ফায়ারবেজ কনফিগারেশন ---
        const firebaseConfig = {
            apiKey: "AIzaSyADEk13HgPmPjiy2VD6RDYU_Z2pPJFM9gQ",
            authDomain: "pingme-7fad3.firebaseapp.com",
            databaseURL: "https://pingme-7fad3-default-rtdb.firebaseio.com",
            projectId: "pingme-7fad3",
            storageBucket: "pingme-7fad3.firebasestorage.app",
            messagingSenderId: "8513825883",
            appId: "1:8513825883:web:b8676bbdb4818c3d4ae37e",
            measurementId: "G-TNN3P5YP"
        };
        
        const appId = firebaseConfig.projectId || 'default-chat-app';


        // === গ্লোবাল ভ্যারিয়েবলস ===
        let auth, db, storage;
        let currentUserId = null;
        let currentUserData = null;
        let currentChatRoomId = null;
        let currentPartnerId = null;
        let currentPartnerInfo = {}; // === পরিবর্তিত: পার্টনারের তথ্য অবজেক্ট ===
        let unsubscribeMessages = null;
        let unsubscribeRoom = null;
        let unsubscribeUnreadCounts = null;
        let unsubscribeUserDoc = null;
        let unsubscribeFriendsList = null;
        let unsubscribePartnerStatus = null;
        let isProfileEditing = false;
        let profileFileToUpload = null;
        let profilePicUrlToUse = null;
        let currentViewingFriend = null;
        let typingTimeout = null;
        
        // === নতুন সংযোজন: মেসেজ অ্যাকশন ===
        let currentReplyingMessage = null;
        let currentSelectedMessage = {
            id: null,
            content: null,
            senderId: null,
            isMe: false
        };

        // --- ফায়ারবেজ পাথ ---
        const usersCollectionPath = `artifacts/${appId}/public/data/users`;
        const chatRoomsCollectionPath = `artifacts/${appId}/public/data/chat_rooms`;

        // === DOM এলিমেন্ট নির্বাচন ===
        const loginPage = document.getElementById('login-page');
        const chatListPage = document.getElementById('chat-list-page');
        const friendsPage = document.getElementById('friends-page');
        const groupsPage = document.getElementById('groups-page');
        const profilePage = document.getElementById('profile-page');
        const chatPage = document.getElementById('chat-page');
        const friendProfilePage = document.getElementById('friend-profile-page');
        const allPages = [loginPage, chatListPage, friendsPage, groupsPage, profilePage, chatPage, friendProfilePage];
        const tabPages = [chatListPage, friendsPage, groupsPage, profilePage];

        // লগইন পেজ
        const loginFormContainer = document.getElementById('login-form-container');
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const showRegisterBtn = document.getElementById('show-register-btn');

        // রেজিস্ট্রেশন পেজ
        const registerFormContainer = document.getElementById('register-form-container');
        const registerEmailInput = document.getElementById('register-email');
        const registerPasswordInput = document.getElementById('register-password');
        const registerConfirmPasswordInput = document.getElementById('register-confirm-password');
        const registerBtn = document.getElementById('register-btn');
        const registerMessage = document.getElementById('register-message');
        const showLoginBtn = document.getElementById('show-login-btn');

        // নেভিগেশন
        const bottomNav = document.getElementById('bottom-nav');
        const navButtons = document.querySelectorAll('.nav-btn');

        // চ্যাট লিস্ট
        const chatListContainer = document.getElementById('chat-list-container');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIconDark = document.getElementById('theme-icon-dark');
        const themeIconLight = document.getElementById('theme-icon-light');

        // ফ্রেন্ডস লিস্ট
        const friendsPageContainer = document.getElementById('friends-page-container');
        const friendSearchInput = document.getElementById('friend-search-input');
        const friendSearchBtn = document.getElementById('friend-search-btn');
        const friendSearchResults = document.getElementById('friend-search-results');

        // প্রোফাইল পেজ
        const profilePicPreview = document.getElementById('profile-pic-preview');
        const profilePicInput = document.getElementById('profile-pic-input');
        const changePicBtn = document.getElementById('change-pic-btn');
        const profilePicLinkBtn = document.getElementById('profile-pic-link-btn');
        const profileUserId = document.getElementById('profile-user-id');
        const profileDisplayNameInput = document.getElementById('profile-display-name');
        const profileBioInput = document.getElementById('profile-bio');
        const profileEmailInput = document.getElementById('profile-email');
        const profilePhoneInput = document.getElementById('profile-phone');
        const profileBirthdateInput = document.getElementById('profile-birthdate');
        const profileGenderSelect = document.getElementById('profile-gender');
        const profileMaritalStatusSelect = document.getElementById('profile-marital-status');
        const signOutBtn = document.getElementById('sign-out-btn');
        const toggleProfileEditBtn = document.getElementById('toggle-profile-edit-btn');
        const profileEditIcon = document.getElementById('profile-edit-icon');
        const profileSaveIcon = document.getElementById('profile-save-icon');

        // চ্যাট পেজ
        const messagesContainer = document.getElementById('messages-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const backToChatListButton = document.getElementById('back-to-chat-list');
        const chatHeaderName = document.getElementById('chat-header-name');
        const chatHeaderAvatar = document.getElementById('chat-header-avatar');
        const chatHeaderStatus = document.getElementById('chat-header-status');
        const emojiToggleBtn = document.getElementById('emoji-toggle-btn');
        const emojiPanel = document.getElementById('emoji-panel');
        const sendLinkBtn = document.getElementById('send-link-btn'); 
        const chatHeaderProfileBtn = document.getElementById('chat-header-profile-btn');

        // === নতুন সংযোজন: রিপ্লে প্রিভিউ ===
        const replyPreviewBar = document.getElementById('reply-preview-bar');
        const replyPreviewName = document.getElementById('reply-preview-name');
        const replyPreviewContent = document.getElementById('reply-preview-content');
        const cancelReplyBtn = document.getElementById('cancel-reply-btn');

        // মডাল (নতুন ইউজার প্রোফাইল)
        const profileModal = document.getElementById('profile-modal');
        const displayNameInput = document.getElementById('display-name-input');
        const modalSaveProfileBtn = document.getElementById('modal-save-profile-btn');

        // মডাল (টেক্সট/ইউআরএল প্রম্পট)
        const textPromptModal = document.getElementById('text-prompt-modal');
        const textPromptTitle = document.getElementById('text-prompt-title');
        const textPromptHelper = document.getElementById('text-prompt-helper');
        const textPromptInput = document.getElementById('text-prompt-input');
        const textPromptCancel = document.getElementById('text-prompt-cancel');
        const textPromptSave = document.getElementById('text-prompt-save');
        let textPromptSaveCallback = null;

        // মডাল (বন্ধুর প্রোফাইল)
        const friendProfilePageMain = document.getElementById('friend-profile-page-main');
        const friendProfileBackBtn = document.getElementById('friend-profile-back-btn');
        const friendProfileHeaderName = document.getElementById('friend-profile-header-name');
        const friendProfilePicPreview = document.getElementById('friend-profile-pic-preview');
        const friendProfileUserId = document.getElementById('friend-profile-user-id');
        const friendProfileDisplayName = document.getElementById('friend-profile-display-name');
        const friendProfileBio = document.getElementById('friend-profile-bio');
        const friendProfileEmail = document.getElementById('friend-profile-email');
        const friendProfilePhone = document.getElementById('friend-profile-phone');
        const friendProfileBirthdate = document.getElementById('friend-profile-birthdate');
        const friendProfileGender = document.getElementById('friend-profile-gender');
        const friendProfileMaritalStatus = document.getElementById('friend-profile-marital-status');
        const friendProfileStartChatBtn = document.getElementById('friend-profile-start-chat-btn');
        
        // === নতুন সংযোজন: মেসেজ মেনু মডাল ===
        const messageContextMenu = document.getElementById('message-context-menu');
        const messageContextBackdrop = document.getElementById('message-context-backdrop');
        const menuReplyBtn = document.getElementById('menu-reply-btn');
        const menuEditBtn = document.getElementById('menu-edit-btn');
        const menuDeleteBtn = document.getElementById('menu-delete-btn');
        const menuReactionBtns = document.querySelectorAll('.menu-reaction-btn');

        // === নতুন সংযোজন: কনফার্ম মডাল ===
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalTitle = document.getElementById('confirm-modal-title');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancel = document.getElementById('confirm-modal-cancel');
        const confirmModalConfirm = document.getElementById('confirm-modal-confirm');
        let confirmModalCallback = null;

        // === ইউটিলিটি ফাংশন ===

        // --- থিম টগল ---
        function applyTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                themeIconDark.classList.add('hidden');
                themeIconLight.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeIconDark.classList.remove('hidden');
                themeIconLight.classList.add('hidden');
            }
        }
        function toggleTheme() {
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme();
        }
        
        // --- পেজ ন্যাভিগেশন ---
        function showPage(pageId) {
            allPages.forEach(page => page.classList.add('hidden'));
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) pageToShow.classList.remove('hidden');
            
            if (tabPages.map(p => p.id).includes(pageId)) {
                bottomNav.classList.remove('hidden');
            } else {
                bottomNav.classList.add('hidden');
            }
            navButtons.forEach(btn => {
                const isActive = btn.dataset.page === pageId;
                btn.classList.toggle('text-blue-500', isActive);
                btn.classList.toggle('dark:text-blue-400', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
                btn.classList.toggle('dark:text-gray-400', !isActive);
                btn.classList.toggle('opacity-70', !isActive);
            });
        }

        // --- অথ মেসেজ ---
        function toggleLoginRegister(showLogin) {
            loginFormContainer.classList.toggle('hidden', !showLogin);
            registerFormContainer.classList.toggle('hidden', showLogin);
            loginMessage.innerHTML = '';
            registerMessage.innerHTML = '';
        }
        function showLoginForm() { toggleLoginRegister(true); }
        function showRegisterForm() { toggleLoginRegister(false); }
        function setAuthMessage(element, message, isError) {
            element.innerHTML = `<p class="text-sm ${isError ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">${message}</p>`;
        }

        // --- Ping ID জেনারেটর ---
        function generatePingId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = 'pm_';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // --- টোস্ট নোটিফিকেশন ---
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('bg-green-500', 'bg-red-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            toast.classList.add('toast-show');
            setTimeout(() => {
                toast.classList.remove('toast-show');
            }, 3000);
        }

        // --- Firebase/Authentication ফাংশন ---

        async function handleLogin() {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            if (!email || !password) {
                setAuthMessage(loginMessage, "Please enter both email and password.", true);
                return;
            }
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing In...';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                loginMessage.innerHTML = '';
            } catch (error) {
                console.error("Error signing in: ", error);
                let msg = "Invalid email or password.";
                if(error.code === 'auth/user-not-found') msg = "No account found with this email.";
                if(error.code === 'auth/wrong-password') msg = "Incorrect password. Please try again.";
                setAuthMessage(loginMessage, msg, true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        }

        async function handleRegister() {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            const confirmPassword = registerConfirmPasswordInput.value;

            if (!email || !password || !confirmPassword) {
                setAuthMessage(registerMessage, "Please fill in all fields.", true);
                return;
            }
            if (password !== confirmPassword) {
                setAuthMessage(registerMessage, "Passwords do not match.", true);
                return;
            }
            if (password.length < 6) {
                setAuthMessage(registerMessage, "Password must be at least 6 characters long.", true);
                return;
            }

            registerBtn.disabled = true;
            registerBtn.textContent = 'Registering...';
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const userDocRef = doc(db, usersCollectionPath, user.uid);
                const newUser = {
                    uid: user.uid,
                    displayName: `User-${user.uid.substring(0, 6)}`,
                    email: user.email,
                    photoURL: null,
                    pingId: generatePingId(),
                    createdAt: serverTimestamp(),
                    status: 'offline',
                    lastSeen: serverTimestamp()
                };
                await setDoc(userDocRef, newUser);
                await sendEmailVerification(user);
                await signOut(auth); 
                
                showLoginForm();
                setAuthMessage(loginMessage, "Registration successful! A verification email has been sent. Please verify your email before logging in.", false);
                registerMessage.innerHTML = '';
            } catch (error) {
                console.error("Error registering: ", error);
                let msg = "Could not create account.";
                if(error.code === 'auth/email-already-in-use') msg = "This email is already registered.";
                if(error.code === 'auth/weak-password') msg = "Password is too weak.";
                setAuthMessage(registerMessage, msg, true);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Register';
            }
        }

        async function handleForgotPassword() {
            const email = loginEmailInput.value.trim();
            if (!email) {
                setAuthMessage(loginMessage, "Please enter your email address to reset password.", true);
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                setAuthMessage(loginMessage, "Password reset email sent. Please check your inbox.", false);
            } catch (error) {
                console.error("Error sending password reset email: ", error);
                let msg = "Could not send reset email. Please check the email address.";
                if(error.code === 'auth/user-not-found') msg = "No user found with that email.";
                setAuthMessage(loginMessage, msg, true);
            }
        }

        async function signOutUser() {
            try {
                await updateUserStatus('offline');
                await signOut(auth);
            } catch (error) {
                console.error("Error signing out: ", error);
            }
        }

        // --- ইউজার স্ট্যাটাস ---
        async function updateUserStatus(status) {
            if (!currentUserId) return;
            const userDocRef = doc(db, usersCollectionPath, currentUserId);
            const updateData = { status: status };
            if (status === 'offline') {
                updateData.lastSeen = serverTimestamp();
            }
            try {
                await updateDoc(userDocRef, updateData);
            } catch (error) {
                // প্রথমবার লগইন করার সময় এই এরর আসতে পারে
            }
        }

        // --- নতুন ইউজার প্রোফাইল মডাল ---
        function showProfileModal() { profileModal.classList.remove('hidden'); }
        function hideProfileModal() { profileModal.classList.add('hidden'); }
        async function saveInitialProfile() {
            const name = displayNameInput.value.trim();
            if (name && currentUserId) {
                try {
                    const userDocRef = doc(db, usersCollectionPath, currentUserId);
                    await updateDoc(userDocRef, { displayName: name });
                    currentUserData.displayName = name;
                    hideProfileModal();
                } catch (error) {
                    console.error("Error saving initial profile: ", error);
                }
            }
        }


        // --- ব্যবহারকারীর ডেটা লিসেনার ---
        function setupUserDocumentListener(userId) {
            if (unsubscribeUserDoc) unsubscribeUserDoc();
            const userDocRef = doc(db, usersCollectionPath, userId);
            
            unsubscribeUserDoc = onSnapshot(userDocRef, async (docSnap) => {
                const defaultName = `User-${userId.substring(0, 6)}`;
                if (!docSnap.exists()) {
                    const newUser = {
                        uid: userId,
                        displayName: auth.currentUser.displayName || defaultName,
                        email: auth.currentUser.email,
                        photoURL: auth.currentUser.photoURL || null,
                        pingId: generatePingId(),
                        createdAt: serverTimestamp(),
                        status: 'online',
                        lastSeen: serverTimestamp()
                    };
                    await setDoc(userDocRef, newUser);
                    currentUserData = newUser;
                    showProfileModal();
                } else {
                    currentUserData = docSnap.data();
                    if (!currentUserData.pingId) {
                        await updateDoc(userDocRef, { pingId: generatePingId() });
                    }
                    if (!currentUserData.displayName || currentUserData.displayName === defaultName) {
                         if(auth.currentUser.displayName && auth.currentUser.displayName !== defaultName) {
                            await updateDoc(userDocRef, { displayName: auth.currentUser.displayName });
                            currentUserData.displayName = auth.currentUser.displayName;
                        } else {
                            showProfileModal();
                        }
                    }
                }
                if (!profilePage.classList.contains('hidden')) loadProfileDataToForm();
                
            }, (error) => console.error("Error listening to user document: ", error));
        }

        // --- প্রোফাইল পেজ ফাংশন ---

        function setProfileEditMode(isEditing) {
            isProfileEditing = isEditing;
            const elements = [profileDisplayNameInput, profileBioInput, profilePhoneInput, profileBirthdateInput, profileGenderSelect, profileMaritalStatusSelect, profileEmailInput];
            
            elements.forEach(el => {
                el.disabled = !isEditing;
            });
            
            profileEmailInput.disabled = true; // ইমেল সর্বদা ডিজেবল

            toggleProfileEditBtn.classList.toggle('bg-white/20', isEditing);
            profileEditIcon.classList.toggle('hidden', isEditing);
            profileSaveIcon.classList.toggle('hidden', !isEditing);
            
            changePicBtn.disabled = !isEditing;
            profilePicLinkBtn.disabled = !isEditing;
            changePicBtn.classList.toggle('opacity-50', !isEditing);
            profilePicLinkBtn.classList.toggle('opacity-50', !isEditing);
        }

        function loadProfileDataToForm() {
            if (!currentUserData) return;
            profileUserId.textContent = currentUserData.pingId || '...';
            profilePicPreview.src = currentUserData.photoURL || `https://placehold.co/128x128/fbc02d/ffffff?text=${(currentUserData.displayName || 'U').charAt(0)}`;
            profileDisplayNameInput.value = currentUserData.displayName || '';
            profileBioInput.value = currentUserData.bio || '';
            profileEmailInput.value = currentUserData.email || (auth.currentUser ? auth.currentUser.email : '');
            profilePhoneInput.value = currentUserData.phone || '';
            profileBirthdateInput.value = currentUserData.birthdate || '';
            profileGenderSelect.value = currentUserData.gender || 'not_specified';
            profileMaritalStatusSelect.value = currentUserData.maritalStatus || 'not_specified';
            setProfileEditMode(false);
        }

        function handleProfilePicSelect(e) {
            const file = e.target.files[0];
            if (file) {
                profileFileToUpload = file;
                profilePicUrlToUse = null;
                const reader = new FileReader();
                reader.onload = (event) => {
                    profilePicPreview.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function uploadProfilePicture() {
            if (!profileFileToUpload) return null;
            const storageRef = ref(storage, `profile_pics/${currentUserId}/${profileFileToUpload.name}`);
            const snapshot = await uploadBytes(storageRef, profileFileToUpload);
            return getDownloadURL(snapshot.ref);
        }

        async function saveProfile() {
            if (!currentUserId) return;
            toggleProfileEditBtn.disabled = true;

            try {
                let photoURL = profilePicUrlToUse || currentUserData.photoURL;
                if (profileFileToUpload) {
                    showToast('Uploading photo...', false);
                    photoURL = await uploadProfilePicture();
                    profileFileToUpload = null;
                }

                const profileData = {
                    displayName: profileDisplayNameInput.value.trim() || `User-${currentUserId.substring(0,6)}`,
                    bio: profileBioInput.value.trim(),
                    phone: profilePhoneInput.value.trim(),
                    birthdate: profileBirthdateInput.value,
                    gender: profileGenderSelect.value,
                    maritalStatus: profileMaritalStatusSelect.value,
                    photoURL: photoURL
                };

                const userDocRef = doc(db, usersCollectionPath, currentUserId);
                await updateDoc(userDocRef, profileData);
                
                showToast('Profile saved successfully!');
                setProfileEditMode(false);
            } catch (error) {
                console.error("Error saving profile: ", error);
                showToast('Error saving profile data.', true);
            } finally {
                toggleProfileEditBtn.disabled = false;
            }
        }

        // --- টেক্সট/ইউআরএল প্রম্পট মডাল (পরিবর্তিত) ---
        function showTextPrompt({ title, helperText, placeholder, initialValue, saveCallback }) {
            textPromptTitle.textContent = title;
            textPromptInput.placeholder = placeholder;
            textPromptInput.value = initialValue || '';
            
            if (helperText) {
                textPromptHelper.innerHTML = helperText;
                textPromptHelper.classList.remove('hidden');
            } else {
                textPromptHelper.classList.add('hidden');
            }
            
            textPromptModal.classList.remove('hidden');
            
            textPromptSaveCallback = saveCallback;
        }
        function hideTextPrompt() {
            textPromptModal.classList.add('hidden');
            textPromptSaveCallback = null;
        }

        // --- নতুন সংযোজন: কনফার্মেশন মডাল ---
        function showConfirmModal({ title, text, confirmText, confirmCallback }) {
            confirmModalTitle.textContent = title;
            confirmModalText.textContent = text;
            confirmModalConfirm.textContent = confirmText;
            confirmModal.classList.remove('hidden');
            confirmModalCallback = confirmCallback;
        }
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmModalCallback = null;
        }

        // --- চ্যাট লিস্ট লোড করা ---
        function loadChatList() {
            if (unsubscribeFriendsList) unsubscribeFriendsList();
            
            const q = query(collection(db, chatRoomsCollectionPath), where("participants", "array-contains", currentUserId));
            
            unsubscribeFriendsList = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    chatListContainer.innerHTML = `<div class="text-center pt-10"><span class="px-3 py-1 bg-gray-200 dark:bg-gray-700 text-sm rounded-full">No chats yet. Start a chat from the Friends list.</span></div>`;
                    return;
                }
                
                let chatItemsHTML = [];
                snapshot.forEach(docSnap => {
                    const room = docSnap.data();
                    const chatRoomId = docSnap.id;
                    const partnerId = room.participants.find(p => p !== currentUserId);
                    if (!partnerId) return;

                    const partnerInfo = room.participantInfo?.[partnerId];
                    const partnerName = partnerInfo?.displayName || 'Unknown User';
                    const partnerPhoto = partnerInfo?.photoURL || `https://placehold.co/80x80/fbc02d/ffffff?text=${partnerName.charAt(0)}`;
                    
                    // === নতুন সংযোজন: ডিলিটেড মেসেজ হ্যান্ডলিং ===
                    let lastMessage = room.lastMessage?.text || 'No messages';
                    if (room.lastMessage?.isDeleted) {
                        lastMessage = 'Message deleted';
                    } else if (room.lastMessage?.type === 'image') {
                        lastMessage = 'Sent an image';
                    }
                    
                    const lastMessageTime = room.lastMessage?.timestamp?.toDate()?.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
                    const lastMessageTimestamp = room.lastMessage?.timestamp?.toDate() || new Date(0);
                    const unreadCount = room.unreadCounts?.[currentUserId] || 0;

                    chatItemsHTML.push({
                        html: `
                        <div class="flex items-center space-x-3 p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-md hover:shadow-lg transition-shadow cursor-pointer" data-partner-id="${partnerId}" data-partner-name="${partnerName}" data-partner-photo="${partnerPhoto}">
                            <div class="relative">
                                <img src="${partnerPhoto}" alt="${partnerName}" class="w-14 h-14 rounded-full object-cover" />
                                <span id="unread-count-${chatRoomId}" class="absolute top-0 right-0 w-5 h-5 bg-yellow-400 text-gray-900 text-xs font-bold rounded-full flex items-center justify-center ${unreadCount > 0 ? '' : 'hidden'}">${unreadCount}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h3 class="text-base font-semibold truncate text-gray-900 dark:text-gray-100">${partnerName}</h3>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${lastMessageTime}</p>
                                </div>
                                <!-- === নতুন সংযোজন: ইটালিক === -->
                                <p class="text-sm text-gray-500 dark:text-gray-400 truncate ${room.lastMessage?.isDeleted ? 'italic' : ''}">${lastMessage}</p>
                            </div>
                        </div>
                        `,
                        timestamp: lastMessageTimestamp
                    });
                });

                chatItemsHTML.sort((a, b) => b.timestamp - a.timestamp);
                
                chatListContainer.innerHTML = chatItemsHTML.map(item => item.html).join('');

                chatListContainer.querySelectorAll('[data-partner-id]').forEach(chatEl => {
                    chatEl.addEventListener('click', () => {
                        const partnerData = chatEl.dataset;
                        startChat(partnerData.partnerId, {
                            displayName: partnerData.partnerName,
                            photoURL: partnerData.partnerPhoto
                        });
                    });
                });

            }, (error) => {
                console.error("Error loading chat list: ", error);
                chatListContainer.innerHTML = `<div class="text-center pt-10"><span class="px-3 py-1 bg-red-200 dark:bg-red-700 text-sm rounded-full">Error loading chats.</span></div>`;
            });
        }

        // --- মেসেজ 'seen' হিসাবে মার্ক করা ---
        async function markMessagesAsSeen(chatRoomRef, partnerId) {
            const messagesRef = collection(chatRoomRef, 'messages');
            const q = query(messagesRef, 
                where("senderId", "==", partnerId), 
                where("status", "==", "sent")
            );
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) return;
                
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.update(doc.ref, { status: "seen" });
                });
                
                const roomDoc = await getDoc(chatRoomRef);
                if (roomDoc.exists() && roomDoc.data().lastMessage.senderId === partnerId) {
                    batch.update(chatRoomRef, { "lastMessage.status": "seen" });
                }
                
                await batch.commit();
            } catch (error) {
                console.error("Error marking messages as seen: ", error);
            }
        }

        // --- মেসেজ লোড করা ---
        function loadMessagesAndRoom(chatRoomId, partnerId) {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeRoom) unsubscribeRoom();

            const chatRoomRef = doc(db, chatRoomsCollectionPath, chatRoomId);
            const messagesCollection = collection(db, chatRoomsCollectionPath, chatRoomId, 'messages');
            
            markMessagesAsSeen(chatRoomRef, partnerId);

            unsubscribeMessages = onSnapshot(query(messagesCollection), (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => messages.push({ id: doc.id, ...doc.data() })); // === পরিবর্তিত: doc.id সহ পুশ ===
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                renderMessages(messages);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, (error) => console.error("Error loading messages: ", error));

            unsubscribeRoom = onSnapshot(chatRoomRef, (docSnap) => {
                if (!docSnap.exists()) {
                    if (!unsubscribePartnerStatus) loadPartnerStatus(partnerId);
                    return;
                }
                
                const room = docSnap.data();
                
                if (room.unreadCounts?.[currentUserId] > 0) {
                    if (!chatPage.classList.contains('hidden')) {
                        updateDoc(chatRoomRef, {
                            [`unreadCounts.${currentUserId}`]: 0
                        }).catch(e => console.error("Error resetting unread count: ", e));
                    }
                }
                
                // === পরিবর্তিত: পার্টনার ইনফো আপডেট ===
                if (room.participantInfo?.[partnerId]) {
                    currentPartnerInfo = room.participantInfo[partnerId];
                    chatHeaderName.textContent = currentPartnerInfo.displayName;
                    chatHeaderAvatar.src = currentPartnerInfo.photoURL || `https://placehold.co/40x40/fbc02d/ffffff?text=${currentPartnerInfo.displayName.charAt(0)}`;
                }
                
                const isPartnerTyping = room.typingStatus?.[currentPartnerId] || false;
                
                if (isPartnerTyping) {
                    chatHeaderStatus.textContent = 'Typing...';
                    chatHeaderStatus.classList.add('text-cyan-200');
                    chatHeaderStatus.classList.remove('text-blue-200', 'h-4');
                    
                    if (unsubscribePartnerStatus) {
                        unsubscribePartnerStatus();
                        unsubscribePartnerStatus = null;
                    }
                } else {
                    if (!unsubscribePartnerStatus) {
                        loadPartnerStatus(partnerId);
                    }
                }
            }, (error) => console.error("Error listening to chat room: ", error));
        }

        // --- পার্টনারের স্ট্যাটাস লোড করা ---
        function loadPartnerStatus(partnerId) {
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            const partnerDocRef = doc(db, usersCollectionPath, partnerId);
            
            unsubscribePartnerStatus = onSnapshot(partnerDocRef, (docSnap) => {
                
                if (chatHeaderStatus.textContent === 'Typing...') {
                    return; 
                }

                chatHeaderStatus.classList.remove('h-4');
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    const status = user.status;
                    
                    if (status === 'online') {
                        chatHeaderStatus.textContent = 'Online';
                        chatHeaderStatus.classList.add('text-cyan-200');
                        chatHeaderStatus.classList.remove('text-blue-200');
                    } else {
                        let lastSeenText = 'Offline';
                        if (user.lastSeen) {
                            const lastSeenTime = user.lastSeen.toDate();
                            const now = new Date();
                            if (lastSeenTime.toDateString() === now.toDateString()) {
                                lastSeenText = `Last seen ${lastSeenTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                            } else {
                                lastSeenText = `Last seen ${lastSeenTime.toLocaleDateString([], { month: 'short', day: 'numeric' })}`;
                            }
                        }
                        chatHeaderStatus.textContent = lastSeenText;
                        chatHeaderStatus.classList.remove('text-cyan-200');
                        chatHeaderStatus.classList.add('text-blue-200');
                    }
                } else {
                     chatHeaderStatus.textContent = 'Offline';
                     chatHeaderStatus.classList.remove('text-cyan-200');
                     chatHeaderStatus.classList.add('text-blue-200');
                }
            }, (error) => console.error("Error loading partner status: ", error));
        }

        // --- মেসেজ রেন্ডার করা ---
        function renderMessages(messages) {
            messagesContainer.innerHTML = '';
            messages.forEach(msg => {
                const isMe = msg.senderId === currentUserId;
                const time = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || '';
                
                let statusIcon = '';
                if (isMe && msg.status) {
                    if (msg.status === 'sent') {
                        statusIcon = '<i class="fas fa-check text-xs ml-1 opacity-70"></i>';
                    } else if (msg.status === 'seen') {
                        statusIcon = '<i class="fas fa-check-double text-xs ml-1 text-blue-400"></i>';
                    }
                }

                let contentHTML = '';
                
                // === নতুন সংযোজন: রিপ্লে ব্লক ===
                if (msg.replyTo) {
                    contentHTML += `
                        <div class="quoted-reply">
                            <p class="text-xs font-semibold">${msg.replyTo.senderName}</p>
                            <p class="text-sm opacity-80 truncate">${msg.replyTo.content}</p>
                        </div>
                    `;
                }
                
                // === নতুন সংযোজন: ডিলিটেড মেসেজ ===
                if (msg.isDeleted) {
                    contentHTML += `<p class="text-base break-words italic opacity-70">Message deleted</p>`;
                } else if (msg.type === 'text') {
                    const p = document.createElement('p');
                    p.className = 'text-base break-words';
                    p.textContent = msg.content;
                    contentHTML += p.outerHTML;
                } else if (msg.type === 'image') {
                    contentHTML += `
                        <img src="${msg.content}" alt="Sent image" class="rounded-lg max-w-xs cursor-pointer" onclick="window.open('${msg.content}', '_blank')" />
                    `;
                }

                // === নতুন সংযোজন: রিয়্যাকশন লিস্ট ===
                let reactionsHTML = '';
                if (msg.reactions && Object.keys(msg.reactions).length > 0) {
                    reactionsHTML = '<div class="reaction-list">';
                    for (const [emoji, users] of Object.entries(msg.reactions)) {
                        if (users.length > 0) {
                            reactionsHTML += `<span class="reaction-item">${emoji} ${users.length}</span>`;
                        }
                    }
                    reactionsHTML += '</div>';
                }

                const messageEl = document.createElement('div');
                messageEl.className = `flex w-full items-end space-x-2 ${isMe ? 'justify-end' : 'justify-start'}`;
                
                const partnerAvatar = `
                    <div>
                        <img src="${currentPartnerInfo.photoURL || `https://placehold.co/40x40/fbc02d/ffffff?text=${currentPartnerInfo.displayName.charAt(0)}`}" alt="Avatar" class="w-8 h-8 rounded-full object-cover" />
                    </div>
                `;

                const bubbleClass = isMe ? 'bubble-me bg-blue-500 text-white' : 'bubble-other bg-white dark:bg-gray-700 shadow-md';
                const bubbleHTML = `
                    <div class="max-w-xs md:max-w-md p-3 ${bubbleClass} relative cursor-pointer" 
                         data-message-id="${msg.id}" 
                         data-message-content="${msg.content || ''}"
                         data-message-sender-id="${msg.senderId}"
                         data-is-me="${isMe}"
                         data-is-deleted="${msg.isDeleted || false}"
                         data-message-type="${msg.type || 'text'}">
                         
                        ${contentHTML}
                        
                        <p class="text-xs ${isMe ? 'text-blue-200' : 'text-gray-500 dark:text-gray-400'} mt-1 text-right">
                            ${msg.isEdited ? ' (edited)' : ''}
                            ${time} ${statusIcon}
                        </p>
                        ${reactionsHTML}
                    </div>
                `;
                
                if (isMe) {
                    messageEl.innerHTML = bubbleHTML;
                } else {
                    messageEl.innerHTML = partnerAvatar + bubbleHTML;
                }
                
                messagesContainer.appendChild(messageEl);
            });
            
            // === নতুন সংযোজন: মেসেজ মেনু ইভেন্ট ===
            messagesContainer.querySelectorAll('.cursor-pointer').forEach(bubble => {
                bubble.addEventListener('click', showMessageContextMenu);
            });
        }


        // --- মেসেজ পাঠানো ---
        async function sendGenericMessage(content, type) {
            if (!currentUserId || !currentChatRoomId || !currentPartnerId) return;
            if (type === 'text' && !content.trim()) return;

            const chatRoomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);
            const messagesCollection = collection(db, chatRoomsCollectionPath, currentChatRoomId, 'messages');
            
            // === পরিবর্তিত: addDoc এর বদলে doc() এবং setDoc() ===
            const messageRef = doc(messagesCollection); // নতুন মেসেজের জন্য রেফারেন্স তৈরি

            try {
                const messageData = {
                    messageId: messageRef.id, // === নতুন সংযোজন: মেসেজ আইডি ===
                    senderId: currentUserId,
                    content: content,
                    type: type,
                    timestamp: serverTimestamp(),
                    status: 'sent',
                    reactions: {}, // === নতুন সংযোজন ===
                    isEdited: false, // === নতুন সংযোজন ===
                    isDeleted: false // === নতুন সংযোজন ===
                };

                // === নতুন সংযোজন: রিপ্লে ডেটা যোগ ===
                if (currentReplyingMessage) {
                    messageData.replyTo = currentReplyingMessage;
                }

                await setDoc(messageRef, messageData); // ডেটা সেট করি

                if (!currentUserData) {
                    console.warn("Current user data not loaded for participantInfo");
                }

                // participantInfo আপডেট করি (যদি না থাকে)
                const roomSnap = await getDoc(chatRoomRef);
                const participantInfo = roomSnap.data()?.participantInfo || {};
                
                if (!participantInfo[currentUserId]) {
                    participantInfo[currentUserId] = {
                        displayName: currentUserData?.displayName || 'You',
                        photoURL: currentUserData?.photoURL || null
                    };
                }
                if (!participantInfo[currentPartnerId]) {
                    participantInfo[currentPartnerId] = {
                        displayName: currentPartnerInfo.displayName,
                        photoURL: currentPartnerInfo.photoURL
                    };
                }

                await setDoc(chatRoomRef, {
                    participants: [currentUserId, currentPartnerId],
                    participantInfo: participantInfo,
                    lastMessage: {
                        text: type === 'image' ? 'Sent an image' : content,
                        timestamp: serverTimestamp(),
                        senderId: currentUserId,
                        status: 'sent',
                        type: type,
                        isDeleted: false
                    },
                    unreadCounts: {
                        [currentUserId]: 0,
                        [currentPartnerId]: increment(1)
                    }
                }, { merge: true });

                // === নতুন সংযোজন: রিপ্লে রিসেট ===
                cancelReply();

            } catch (error) {
                console.error("Error sending message: ", error);
            }
        }

        // --- চ্যাট ফর্ম সাবমিট ---
        async function handleChatFormSubmit(e) {
            e.preventDefault();

            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = null;
            if(currentChatRoomId) {
                const chatRoomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);
                updateDoc(chatRoomRef, { [`typingStatus.${currentUserId}`]: false });
            }

            const messageText = messageInput.value.trim();
            if (messageText) {
                messageInput.value = '';
                await sendGenericMessage(messageText, 'text');
            }
        }

        // === নতুন সংযোজন: টাইপিং হ্যান্ডলার ===
        function handleTyping() {
            if (!currentChatRoomId || !currentUserId) return;
            
            const chatRoomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);

            updateDoc(chatRoomRef, { [`typingStatus.${currentUserId}`]: true })
                .catch(e => console.error("Error setting typing status:", e));

            if (typingTimeout) clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                updateDoc(chatRoomRef, { [`typingStatus.${currentUserId}`]: false })
                    .catch(e => console.error("Error clearing typing status:", e));
                typingTimeout = null;
            }, 3000); 
        }
        
        // === নতুন সংযোজন: মেসেজ অ্যাকশন ফাংশন ===
        function showMessageContextMenu(e) {
            const bubble = e.currentTarget;
            const ds = bubble.dataset;
            
            currentSelectedMessage = {
                id: ds.messageId,
                content: ds.messageContent,
                senderId: ds.messageSenderId,
                isMe: ds.isMe === 'true',
                isDeleted: ds.isDeleted === 'true',
                type: ds.messageType
            };

            if (currentSelectedMessage.isDeleted) {
                return; // ডিলিট করা মেসেজে কোনো অ্যাকশন নেই
            }

            // বাটন কন্ডিশন
            menuReplyBtn.classList.remove('hidden');
            menuEditBtn.classList.toggle('hidden', !currentSelectedMessage.isMe || currentSelectedMessage.type !== 'text');
            menuDeleteBtn.classList.toggle('hidden', !currentSelectedMessage.isMe);

            messageContextMenu.classList.remove('hidden');
        }
        
        function hideMessageContextMenu() {
            messageContextMenu.classList.add('hidden');
        }
        
        async function handleReaction(emoji) {
            hideMessageContextMenu();
            const msgRef = doc(db, chatRoomsCollectionPath, currentChatRoomId, 'messages', currentSelectedMessage.id);
            
            try {
                const msgSnap = await getDoc(msgRef);
                if (!msgSnap.exists()) return;
                
                const msgData = msgSnap.data();
                const reactions = msgData.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }
                
                const userIndex = reactions[emoji].indexOf(currentUserId);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1); // আন-রিয়্যাক্ট
                } else {
                    reactions[emoji].push(currentUserId); // রিয়্যাক্ট
                }
                
                await updateDoc(msgRef, { reactions: reactions });
                
            } catch (error) {
                console.error("Error handling reaction: ", error);
            }
        }
        
        function startReply() {
            hideMessageContextMenu();
            
            const senderName = currentSelectedMessage.isMe ? 'You' : currentPartnerInfo.displayName;
            
            currentReplyingMessage = {
                messageId: currentSelectedMessage.id,
                content: currentSelectedMessage.content,
                senderName: senderName
            };
            
            replyPreviewName.textContent = `Replying to ${senderName}`;
            replyPreviewContent.textContent = currentSelectedMessage.content;
            replyPreviewBar.classList.remove('hidden');
            messageInput.focus();
        }
        
        function cancelReply() {
            currentReplyingMessage = null;
            replyPreviewBar.classList.add('hidden');
        }
        
        function startEdit() {
            hideMessageContextMenu();
            showTextPrompt({
                title: "Edit Message",
                placeholder: "Enter new message...",
                initialValue: currentSelectedMessage.content,
                saveCallback: saveEdit
            });
        }
        
        async function saveEdit() {
            const newContent = textPromptInput.value.trim();
            if (!newContent) return;
            
            const msgRef = doc(db, chatRoomsCollectionPath, currentChatRoomId, 'messages', currentSelectedMessage.id);
            try {
                await updateDoc(msgRef, {
                    content: newContent,
                    isEdited: true
                });
                
                // === নতুন সংযোজন: লাস্ট মেসেজ আপডেট ===
                const roomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.data().lastMessage.timestamp.toMillis() === (await getDoc(msgRef)).data().timestamp.toMillis()) {
                    await updateDoc(roomRef, {
                        "lastMessage.text": newContent
                    });
                }
                
                hideTextPrompt();
            } catch (error) {
                console.error("Error editing message: ", error);
            }
        }
        
        function confirmDelete() {
            hideMessageContextMenu();
            showConfirmModal({
                title: "Delete Message",
                text: "Are you sure you want to delete this message? This will delete it for everyone.",
                confirmText: "Delete",
                confirmCallback: deleteMessage
            });
        }
        
        async function deleteMessage() {
            const msgRef = doc(db, chatRoomsCollectionPath, currentChatRoomId, 'messages', currentSelectedMessage.id);
            try {
                await updateDoc(msgRef, {
                    content: "Message deleted",
                    type: "text",
                    isDeleted: true,
                    reactions: {},
                    replyTo: null
                });
                
                // === নতুন সংযোজন: লাস্ট মেসেজ আপডেট ===
                const roomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.data().lastMessage.timestamp.toMillis() === (await getDoc(msgRef)).data().timestamp.toMillis()) {
                    await updateDoc(roomRef, {
                        "lastMessage.text": "Message deleted",
                        "lastMessage.isDeleted": true
                    });
                }
                
                hideConfirmModal();
            } catch (error) {
                console.error("Error deleting message: ", error);
            }
        }

        // --- বন্ধু সার্চ করা ---
        async function searchFriends() {
            const pingId = friendSearchInput.value.trim(); 
            
            if (!pingId) {
                friendSearchResults.innerHTML = '';
                return;
            }
            if (pingId === (currentUserData?.pingId || '')) {
                 friendSearchResults.innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">That\'s you!</div>';
                 return;
            }

            friendSearchResults.innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">Searching...</div>';

            const q = query(collection(db, usersCollectionPath), where("pingId", "==", pingId));

            try {
                const querySnapshot = await getDocs(q);
                
                friendSearchResults.innerHTML = ''; 

                if (querySnapshot.empty) {
                    friendSearchResults.innerHTML = '<div class="text-center p-4 text-gray-500 dark:text-gray-400">No user found with that Ping ID.</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    const friendEl = document.createElement('div');
                    friendEl.className = 'friend-item flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded-2xl shadow-md cursor-pointer hover:shadow-lg transition-shadow';
                    
                    const userPhoto = user.photoURL || `https://placehold.co/80x80/fbc02d/ffffff?text=${(user.displayName || '?').charAt(0)}`;
                    const userName = user.displayName || 'Unnamed User';

                    friendEl.innerHTML = `
                        <div class="flex items-center space-x-3 min-w-0">
                            <img src="${userPhoto}" alt="${userName}" class="w-12 h-12 rounded-full object-cover" />
                            <div class="min-w-0">
                                <h3 class="text-base font-semibold truncate text-gray-900 dark:text-gray-100">${userName}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">@${user.pingId || '...'}</p>
                            </div>
                        </div>
                        <button class="start-chat-btn p-2 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 rounded-full hover:bg-blue-200 dark:hover:bg-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    
                    const startChatBtn = friendEl.querySelector('.start-chat-btn');
                    startChatBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        startChat(user.uid, { displayName: userName, photoURL: userPhoto });
                    });
                    
                    friendEl.addEventListener('click', () => {
                        showFriendProfilePage('friends-page', user.uid);
                    });
                    
                    friendSearchResults.appendChild(friendEl);
                });
            } catch (error) {
                console.error("Error searching friends: ", error);
                friendSearchResults.innerHTML = '<div class="text-center p-4 text-red-500 dark:text-red-400">An error occurred during search.</div>';
            }
        }
        
        // --- চ্যাট শুরু করা ---
        async function startChat(partnerId, partnerData) {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            
            showPage('chat-page');
            
            // === পরিবর্তিত: পার্টনার ইনফো সেট ===
            currentPartnerInfo = {
                displayName: partnerData.displayName,
                photoURL: partnerData.photoURL || `https://placehold.co/40x40/fbc02d/ffffff?text=${partnerData.displayName.charAt(0)}`
            };
            
            chatHeaderName.textContent = currentPartnerInfo.displayName;
            chatHeaderAvatar.src = currentPartnerInfo.photoURL;
            chatHeaderStatus.textContent = "Loading status...";
            chatHeaderStatus.classList.remove('h-4');
            currentPartnerId = partnerId;
            
            currentChatRoomId = currentUserId < partnerId ? `${currentUserId}_${partnerId}` : `${partnerId}_${currentUserId}`;

            messagesContainer.innerHTML = '';
            loadMessagesAndRoom(currentChatRoomId, partnerId);
            loadPartnerStatus(partnerId);
        }

        // --- বন্ধুর প্রোফাইল পেজ দেখানো ---
        async function showFriendProfilePage(originPage, userId) {
            if (!userId) return;

            currentViewingFriend = { uid: userId };
            showPage('friend-profile-page');
            friendProfilePage.dataset.origin = originPage;

            friendProfileHeaderName.textContent = "Loading...";
            friendProfilePicPreview.src = `https://placehold.co/128x128/fbc02d/ffffff?text=?`;
            const fields = [
                friendProfileUserId, friendProfileDisplayName, friendProfileBio, 
                friendProfileEmail, friendProfilePhone, friendProfileBirthdate, 
                friendProfileGender, friendProfileMaritalStatus
            ];
            fields.forEach(f => { f.textContent = '...'; });

            try {
                const userDocRef = doc(db, usersCollectionPath, userId);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    const user = docSnap.data();
                    
                    const displayName = user.displayName || 'Unknown User';
                    const photoURL = user.photoURL || `https://placehold.co/128x128/fbc02d/ffffff?text=${(displayName || '?').charAt(0)}`;

                    currentViewingFriend = {
                        uid: user.uid,
                        displayName: displayName,
                        photoURL: photoURL
                    };

                    friendProfileHeaderName.textContent = `${displayName}'s Profile`;
                    friendProfilePicPreview.src = photoURL;
                    friendProfileUserId.textContent = user.pingId || 'N/A';
                    friendProfileDisplayName.textContent = displayName || 'N/A';
                    friendProfileBio.textContent = user.bio || 'No bio provided.';
                    friendProfileEmail.textContent = user.email || 'N/A';
                    friendProfilePhone.textContent = user.phone || 'N/A';
                    friendProfileBirthdate.textContent = user.birthdate || 'N/A';
                    
                    const genderMap = { 'male': 'Male', 'female': 'Female', 'other': 'Other', 'not_specified': 'Prefer not to say' };
                    const maritalMap = { 'single': 'Single', 'married': 'Married', 'divorced': 'Divorced', 'widowed': 'Widowed', 'not_specified': 'Prefer not to say' };

                    friendProfileGender.textContent = genderMap[user.gender] || genderMap['not_specified'];
                    friendProfileMaritalStatus.textContent = maritalMap[user.maritalStatus] || maritalMap['not_specified'];
                } else {
                    friendProfileHeaderName.textContent = "User Not Found";
                    friendProfileBio.textContent = "The user profile could not be loaded.";
                }
            } catch (error) {
                console.error("Error loading friend profile: ", error);
                friendProfileHeaderName.textContent = "Error";
                friendProfileBio.textContent = "An error occurred while loading the profile.";
            }
        }

        // --- সকল লিসেনার বন্ধ করা ---
        function cleanupAllListeners() {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeUnreadCounts) unsubscribeUnreadCounts();
            if (unsubscribeUserDoc) unsubscribeUserDoc();
            if (unsubscribeFriendsList) unsubscribeFriendsList();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            
            unsubscribeMessages = null;
            unsubscribeRoom = null;
            unsubscribeUnreadCounts = null;
            unsubscribeUserDoc = null;
            unsubscribeFriendsList = null;
            unsubscribePartnerStatus = null;
        }

        // --- অ্যাপ চালু করা ---
        async function initApp() {
            if (!firebaseConfig.apiKey) {
                document.body.innerHTML = '<div style="color: red; padding: 20px;">Error: Firebase configuration is missing.</div>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);
                setLogLevel('Debug');
                const analytics = getAnalytics(app);

                document.addEventListener("visibilitychange", () => {
                    if (auth.currentUser) {
                        if (document.visibilityState === "visible") {
                            updateUserStatus('online');
                        } else {
                            updateUserStatus('offline');
                        }
                    }
                });

                window.addEventListener('beforeunload', (e) => {
                    if (auth.currentUser) {
                        updateUserStatus('offline');
                    }
                });

                onAuthStateChanged(auth, async (user) => {
                    cleanupAllListeners();
                    if (user) {
                        if (user.emailVerified) {
                            currentUserId = user.uid;
                            await updateUserStatus('online');
                            setupUserDocumentListener(user.uid);
                            messageInput.disabled = false;
                            sendButton.disabled = false;
                            loadChatList();
                            friendSearchInput.placeholder = "Enter friend's Ping ID";
                            showPage('chat-list-page');
                        } else {
                            currentUserId = null;
                            showPage('login-page');
                            loginMessage.innerHTML = `
                                <p class="text-sm text-yellow-600 dark:text-yellow-400">
                                    A verification email was sent to <strong>${user.email}</strong>. 
                                    Please check your inbox (and spam folder) to verify your account.
                                </p>
                                <button id="resend-verification-btn" class="w-full mt-2 text-sm text-blue-600 dark:text-blue-400 hover:underline">
                                    Resend verification email
                                </button>
                            `;
                            if(document.getElementById('resend-verification-btn')) {
                                document.getElementById('resend-verification-btn').addEventListener('click', async () => {
                                    try {
                                        await sendEmailVerification(user);
                                        setAuthMessage(loginMessage, `Verification email resent to <strong>${user.email}</strong>.`, false);
                                    } catch (error) {
                                        console.error("Error resending verification: ", error);
                                        setAuthMessage(loginMessage, `Error: ${error.message}`, true);
                                    }
                                });
                            }
                        }
                    } else {
                        currentUserId = null;
                        currentUserData = null;
                        showPage('login-page');
                        bottomNav.classList.add('hidden');
                        loginMessage.innerHTML = '';
                        showLoginForm();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed: ", error);
                document.body.innerHTML = `<div style="color: red; padding: 20px;">Error: Firebase initialization failed. Check your console for details.</div>`;
            }
        }


        // === ইভেন্ট লিসেনার্স ===

        initApp();
        applyTheme();

        // থিম টগল
        themeToggle.addEventListener('click', toggleTheme);

        // লগইন/রেজিস্ট্রেশন টগল
        showRegisterBtn.addEventListener('click', showRegisterForm);
        showLoginBtn.addEventListener('click', showLoginForm);

        // লগইন/রেজিস্ট্রেশন বাটন
        loginBtn.addEventListener('click', handleLogin);
        registerBtn.addEventListener('click', handleRegister);
        forgotPasswordBtn.addEventListener('click', handleForgotPassword);
        
        // নতুন ইউজার প্রোফাইল মডাল সেভ
        modalSaveProfileBtn.addEventListener('click', saveInitialProfile);

        // বটম নেভিগেশন
        navButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const pageId = btn.dataset.page;
                showPage(pageId);
                if (pageId === 'profile-page') loadProfileDataToForm();
            });
        });

        // জেনেরিক ব্যাক বাটন
        document.querySelectorAll('.nav-back-btn').forEach(btn => {
             btn.addEventListener('click', () => {
                const targetPage = btn.dataset.target || 'chat-list-page';
                showPage(targetPage);
             });
        });

        // ফ্রেন্ডস পেজ
        friendSearchBtn.addEventListener('click', searchFriends);
        friendSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchFriends();
            }
        });

        // প্রোফাইল পেজ
        changePicBtn.addEventListener('click', () => { if(isProfileEditing) profilePicInput.click() });
        profilePicInput.addEventListener('change', handleProfilePicSelect);
        
        profilePicLinkBtn.addEventListener('click', () => { 
            if(!isProfileEditing) return;
            showTextPrompt({
                title: "Enter Profile Image URL",
                helperText: `Need to upload an image? Try: <a href="https://postimages.org/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">postimages.org</a>`,
                placeholder: "https://example.com/image.jpg",
                saveCallback: () => {
                    const url = textPromptInput.value.trim();
                    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                        profilePicPreview.src = url;
                        profilePicUrlToUse = url;
                        profileFileToUpload = null;
                        hideTextPrompt();
                    } else if (url) {
                        showToast('Invalid URL. Must start with http:// or https://', true);
                    }
                }
            });
        });

        signOutBtn.addEventListener('click', signOutUser);
        
        toggleProfileEditBtn.addEventListener('click', async () => {
            if (isProfileEditing) {
                await saveProfile(); 
            } else {
                setProfileEditMode(true);
            }
        });

        // চ্যাট পেজ
        chatForm.addEventListener('submit', handleChatFormSubmit);
        messageInput.addEventListener('input', handleTyping);
        cancelReplyBtn.addEventListener('click', cancelReply); // === নতুন সংযোজন ===

        backToChatListButton.addEventListener('click', () => {
            showPage('chat-list-page');
            
            if (typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = null;
            if (currentChatRoomId && currentUserId) {
                const chatRoomRef = doc(db, chatRoomsCollectionPath, currentChatRoomId);
                updateDoc(chatRoomRef, { [`typingStatus.${currentUserId}`]: false });
            }

            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribePartnerStatus) unsubscribePartnerStatus();
            currentChatRoomId = null;
            currentPartnerId = null;
            currentPartnerInfo = {}; // === পরিবর্তিত ===
            chatHeaderStatus.textContent = '\u00A0';
            chatHeaderStatus.classList.add('h-4');
            cancelReply(); // === নতুন সংযোজন ===
        });
        
        emojiToggleBtn.addEventListener('click', () => {
            emojiPanel.classList.toggle('hidden');
        });

        document.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                messageInput.value += btn.textContent;
                messageInput.focus();
                emojiPanel.classList.add('hidden');
            });
        });

        // লিংক বাটন ইভেন্ট (পরিবর্তিত)
        sendLinkBtn.addEventListener('click', () => {
            showTextPrompt({
                title: "Enter Image URL",
                helperText: `Need to upload an image? Try: <a href="https://postimages.org/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">postimages.org</a>`,
                placeholder: "https://example.com/image.jpg",
                saveCallback: () => {
                    const url = textPromptInput.value.trim();
                    if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
                        sendGenericMessage(url, 'image');
                        hideTextPrompt();
                    } else if (url) {
                        showToast('Invalid URL. Must start with http:// or https://', true);
                    }
                }
            });
        });

        // === নতুন সংযোজন: টেক্সট প্রম্পট মডাল বাটন ===
        textPromptCancel.addEventListener('click', hideTextPrompt);
        textPromptSave.addEventListener('click', () => {
            if (textPromptSaveCallback) textPromptSaveCallback();
        });

        // === নতুন সংযোজন: কনফার্ম মডাল বাটন ===
        confirmModalCancel.addEventListener('click', hideConfirmModal);
        confirmModalConfirm.addEventListener('click', () => {
            if (confirmModalCallback) confirmModalCallback();
        });
        
        // === নতুন সংযোজন: মেসেজ মেনু বাটন ===
        messageContextBackdrop.addEventListener('click', hideMessageContextMenu);
        menuReplyBtn.addEventListener('click', startReply);
        menuEditBtn.addEventListener('click', startEdit);
        menuDeleteBtn.addEventListener('click', confirmDelete);
        menuReactionBtns.forEach(btn => {
            btn.addEventListener('click', () => handleReaction(btn.dataset.emoji));
        });


        chatHeaderProfileBtn.addEventListener('click', () => {
            if (currentPartnerId) {
                showFriendProfilePage('chat-page', currentPartnerId);
            }
        });

        // বন্ধুর প্রোফাইল পেজ
        friendProfileBackBtn.addEventListener('click', () => {
            const originPage = friendProfilePage.dataset.origin || 'chat-list-page';
            showPage(originPage);
        });

        friendProfileStartChatBtn.addEventListener('click', () => {
            if (currentViewingFriend) {
                startChat(currentViewingFriend.uid, {
                    displayName: currentViewingFriend.displayName,
                    photoURL: currentViewingFriend.photoURL
                });
            }
        });

    </script>
</body>
</html>

